<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `/home/runner/.cargo/git/checkouts/libsignal-client-20b116e5080385e2/2c32fb8/rust/protocol/src/sealed_sender.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>sealed_sender.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script src="../../crates.js"></script><script defer src="../../main.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script>
    <noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../libsignal_protocol/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../libsignal_protocol/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../libsignal_protocol/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
<span id="859">859</span>
<span id="860">860</span>
<span id="861">861</span>
<span id="862">862</span>
<span id="863">863</span>
<span id="864">864</span>
<span id="865">865</span>
<span id="866">866</span>
<span id="867">867</span>
<span id="868">868</span>
<span id="869">869</span>
<span id="870">870</span>
<span id="871">871</span>
<span id="872">872</span>
<span id="873">873</span>
<span id="874">874</span>
<span id="875">875</span>
<span id="876">876</span>
<span id="877">877</span>
<span id="878">878</span>
<span id="879">879</span>
<span id="880">880</span>
<span id="881">881</span>
<span id="882">882</span>
<span id="883">883</span>
<span id="884">884</span>
<span id="885">885</span>
<span id="886">886</span>
<span id="887">887</span>
<span id="888">888</span>
<span id="889">889</span>
<span id="890">890</span>
<span id="891">891</span>
<span id="892">892</span>
<span id="893">893</span>
<span id="894">894</span>
<span id="895">895</span>
<span id="896">896</span>
<span id="897">897</span>
<span id="898">898</span>
<span id="899">899</span>
<span id="900">900</span>
<span id="901">901</span>
<span id="902">902</span>
<span id="903">903</span>
<span id="904">904</span>
<span id="905">905</span>
<span id="906">906</span>
<span id="907">907</span>
<span id="908">908</span>
<span id="909">909</span>
<span id="910">910</span>
<span id="911">911</span>
<span id="912">912</span>
<span id="913">913</span>
<span id="914">914</span>
<span id="915">915</span>
<span id="916">916</span>
<span id="917">917</span>
<span id="918">918</span>
<span id="919">919</span>
<span id="920">920</span>
<span id="921">921</span>
<span id="922">922</span>
<span id="923">923</span>
<span id="924">924</span>
<span id="925">925</span>
<span id="926">926</span>
<span id="927">927</span>
<span id="928">928</span>
<span id="929">929</span>
<span id="930">930</span>
<span id="931">931</span>
<span id="932">932</span>
<span id="933">933</span>
<span id="934">934</span>
<span id="935">935</span>
<span id="936">936</span>
<span id="937">937</span>
<span id="938">938</span>
<span id="939">939</span>
<span id="940">940</span>
<span id="941">941</span>
<span id="942">942</span>
<span id="943">943</span>
<span id="944">944</span>
<span id="945">945</span>
<span id="946">946</span>
<span id="947">947</span>
<span id="948">948</span>
<span id="949">949</span>
<span id="950">950</span>
<span id="951">951</span>
<span id="952">952</span>
<span id="953">953</span>
<span id="954">954</span>
<span id="955">955</span>
<span id="956">956</span>
<span id="957">957</span>
<span id="958">958</span>
<span id="959">959</span>
<span id="960">960</span>
<span id="961">961</span>
<span id="962">962</span>
<span id="963">963</span>
<span id="964">964</span>
<span id="965">965</span>
<span id="966">966</span>
<span id="967">967</span>
<span id="968">968</span>
<span id="969">969</span>
<span id="970">970</span>
<span id="971">971</span>
<span id="972">972</span>
<span id="973">973</span>
<span id="974">974</span>
<span id="975">975</span>
<span id="976">976</span>
<span id="977">977</span>
<span id="978">978</span>
<span id="979">979</span>
<span id="980">980</span>
<span id="981">981</span>
<span id="982">982</span>
<span id="983">983</span>
<span id="984">984</span>
<span id="985">985</span>
<span id="986">986</span>
<span id="987">987</span>
<span id="988">988</span>
<span id="989">989</span>
<span id="990">990</span>
<span id="991">991</span>
<span id="992">992</span>
<span id="993">993</span>
<span id="994">994</span>
<span id="995">995</span>
<span id="996">996</span>
<span id="997">997</span>
<span id="998">998</span>
<span id="999">999</span>
<span id="1000">1000</span>
<span id="1001">1001</span>
<span id="1002">1002</span>
<span id="1003">1003</span>
<span id="1004">1004</span>
<span id="1005">1005</span>
<span id="1006">1006</span>
<span id="1007">1007</span>
<span id="1008">1008</span>
<span id="1009">1009</span>
<span id="1010">1010</span>
<span id="1011">1011</span>
<span id="1012">1012</span>
<span id="1013">1013</span>
<span id="1014">1014</span>
<span id="1015">1015</span>
<span id="1016">1016</span>
<span id="1017">1017</span>
<span id="1018">1018</span>
<span id="1019">1019</span>
<span id="1020">1020</span>
<span id="1021">1021</span>
<span id="1022">1022</span>
<span id="1023">1023</span>
<span id="1024">1024</span>
<span id="1025">1025</span>
<span id="1026">1026</span>
<span id="1027">1027</span>
<span id="1028">1028</span>
<span id="1029">1029</span>
<span id="1030">1030</span>
<span id="1031">1031</span>
<span id="1032">1032</span>
<span id="1033">1033</span>
<span id="1034">1034</span>
<span id="1035">1035</span>
<span id="1036">1036</span>
<span id="1037">1037</span>
<span id="1038">1038</span>
<span id="1039">1039</span>
<span id="1040">1040</span>
<span id="1041">1041</span>
<span id="1042">1042</span>
<span id="1043">1043</span>
<span id="1044">1044</span>
<span id="1045">1045</span>
<span id="1046">1046</span>
<span id="1047">1047</span>
<span id="1048">1048</span>
<span id="1049">1049</span>
<span id="1050">1050</span>
<span id="1051">1051</span>
<span id="1052">1052</span>
<span id="1053">1053</span>
<span id="1054">1054</span>
<span id="1055">1055</span>
<span id="1056">1056</span>
<span id="1057">1057</span>
<span id="1058">1058</span>
<span id="1059">1059</span>
<span id="1060">1060</span>
<span id="1061">1061</span>
<span id="1062">1062</span>
<span id="1063">1063</span>
<span id="1064">1064</span>
<span id="1065">1065</span>
<span id="1066">1066</span>
<span id="1067">1067</span>
<span id="1068">1068</span>
<span id="1069">1069</span>
<span id="1070">1070</span>
<span id="1071">1071</span>
<span id="1072">1072</span>
<span id="1073">1073</span>
<span id="1074">1074</span>
<span id="1075">1075</span>
<span id="1076">1076</span>
<span id="1077">1077</span>
<span id="1078">1078</span>
<span id="1079">1079</span>
<span id="1080">1080</span>
<span id="1081">1081</span>
<span id="1082">1082</span>
<span id="1083">1083</span>
<span id="1084">1084</span>
<span id="1085">1085</span>
<span id="1086">1086</span>
<span id="1087">1087</span>
<span id="1088">1088</span>
<span id="1089">1089</span>
<span id="1090">1090</span>
<span id="1091">1091</span>
<span id="1092">1092</span>
<span id="1093">1093</span>
<span id="1094">1094</span>
<span id="1095">1095</span>
<span id="1096">1096</span>
<span id="1097">1097</span>
<span id="1098">1098</span>
<span id="1099">1099</span>
<span id="1100">1100</span>
<span id="1101">1101</span>
<span id="1102">1102</span>
<span id="1103">1103</span>
<span id="1104">1104</span>
<span id="1105">1105</span>
<span id="1106">1106</span>
<span id="1107">1107</span>
<span id="1108">1108</span>
<span id="1109">1109</span>
<span id="1110">1110</span>
<span id="1111">1111</span>
<span id="1112">1112</span>
<span id="1113">1113</span>
<span id="1114">1114</span>
<span id="1115">1115</span>
<span id="1116">1116</span>
<span id="1117">1117</span>
<span id="1118">1118</span>
<span id="1119">1119</span>
<span id="1120">1120</span>
<span id="1121">1121</span>
<span id="1122">1122</span>
<span id="1123">1123</span>
<span id="1124">1124</span>
<span id="1125">1125</span>
<span id="1126">1126</span>
<span id="1127">1127</span>
<span id="1128">1128</span>
<span id="1129">1129</span>
<span id="1130">1130</span>
<span id="1131">1131</span>
<span id="1132">1132</span>
<span id="1133">1133</span>
<span id="1134">1134</span>
<span id="1135">1135</span>
<span id="1136">1136</span>
<span id="1137">1137</span>
<span id="1138">1138</span>
<span id="1139">1139</span>
<span id="1140">1140</span>
<span id="1141">1141</span>
<span id="1142">1142</span>
<span id="1143">1143</span>
<span id="1144">1144</span>
<span id="1145">1145</span>
<span id="1146">1146</span>
<span id="1147">1147</span>
<span id="1148">1148</span>
<span id="1149">1149</span>
<span id="1150">1150</span>
<span id="1151">1151</span>
<span id="1152">1152</span>
<span id="1153">1153</span>
<span id="1154">1154</span>
<span id="1155">1155</span>
<span id="1156">1156</span>
<span id="1157">1157</span>
<span id="1158">1158</span>
<span id="1159">1159</span>
<span id="1160">1160</span>
<span id="1161">1161</span>
<span id="1162">1162</span>
<span id="1163">1163</span>
<span id="1164">1164</span>
<span id="1165">1165</span>
<span id="1166">1166</span>
<span id="1167">1167</span>
<span id="1168">1168</span>
<span id="1169">1169</span>
<span id="1170">1170</span>
<span id="1171">1171</span>
<span id="1172">1172</span>
<span id="1173">1173</span>
<span id="1174">1174</span>
<span id="1175">1175</span>
<span id="1176">1176</span>
<span id="1177">1177</span>
<span id="1178">1178</span>
<span id="1179">1179</span>
<span id="1180">1180</span>
<span id="1181">1181</span>
<span id="1182">1182</span>
<span id="1183">1183</span>
<span id="1184">1184</span>
<span id="1185">1185</span>
<span id="1186">1186</span>
<span id="1187">1187</span>
<span id="1188">1188</span>
<span id="1189">1189</span>
<span id="1190">1190</span>
<span id="1191">1191</span>
<span id="1192">1192</span>
<span id="1193">1193</span>
<span id="1194">1194</span>
<span id="1195">1195</span>
<span id="1196">1196</span>
<span id="1197">1197</span>
<span id="1198">1198</span>
<span id="1199">1199</span>
<span id="1200">1200</span>
<span id="1201">1201</span>
<span id="1202">1202</span>
<span id="1203">1203</span>
<span id="1204">1204</span>
<span id="1205">1205</span>
<span id="1206">1206</span>
<span id="1207">1207</span>
<span id="1208">1208</span>
<span id="1209">1209</span>
<span id="1210">1210</span>
<span id="1211">1211</span>
<span id="1212">1212</span>
<span id="1213">1213</span>
<span id="1214">1214</span>
<span id="1215">1215</span>
<span id="1216">1216</span>
<span id="1217">1217</span>
<span id="1218">1218</span>
<span id="1219">1219</span>
<span id="1220">1220</span>
<span id="1221">1221</span>
<span id="1222">1222</span>
<span id="1223">1223</span>
<span id="1224">1224</span>
<span id="1225">1225</span>
<span id="1226">1226</span>
<span id="1227">1227</span>
<span id="1228">1228</span>
<span id="1229">1229</span>
<span id="1230">1230</span>
<span id="1231">1231</span>
<span id="1232">1232</span>
<span id="1233">1233</span>
<span id="1234">1234</span>
<span id="1235">1235</span>
<span id="1236">1236</span>
<span id="1237">1237</span>
<span id="1238">1238</span>
<span id="1239">1239</span>
<span id="1240">1240</span>
<span id="1241">1241</span>
<span id="1242">1242</span>
<span id="1243">1243</span>
<span id="1244">1244</span>
<span id="1245">1245</span>
<span id="1246">1246</span>
<span id="1247">1247</span>
<span id="1248">1248</span>
<span id="1249">1249</span>
<span id="1250">1250</span>
<span id="1251">1251</span>
<span id="1252">1252</span>
<span id="1253">1253</span>
<span id="1254">1254</span>
<span id="1255">1255</span>
<span id="1256">1256</span>
<span id="1257">1257</span>
<span id="1258">1258</span>
<span id="1259">1259</span>
<span id="1260">1260</span>
<span id="1261">1261</span>
<span id="1262">1262</span>
<span id="1263">1263</span>
<span id="1264">1264</span>
<span id="1265">1265</span>
<span id="1266">1266</span>
<span id="1267">1267</span>
<span id="1268">1268</span>
<span id="1269">1269</span>
<span id="1270">1270</span>
<span id="1271">1271</span>
<span id="1272">1272</span>
<span id="1273">1273</span>
<span id="1274">1274</span>
<span id="1275">1275</span>
<span id="1276">1276</span>
<span id="1277">1277</span>
<span id="1278">1278</span>
<span id="1279">1279</span>
<span id="1280">1280</span>
<span id="1281">1281</span>
<span id="1282">1282</span>
<span id="1283">1283</span>
<span id="1284">1284</span>
<span id="1285">1285</span>
<span id="1286">1286</span>
<span id="1287">1287</span>
<span id="1288">1288</span>
<span id="1289">1289</span>
<span id="1290">1290</span>
<span id="1291">1291</span>
<span id="1292">1292</span>
<span id="1293">1293</span>
<span id="1294">1294</span>
<span id="1295">1295</span>
<span id="1296">1296</span>
<span id="1297">1297</span>
<span id="1298">1298</span>
<span id="1299">1299</span>
<span id="1300">1300</span>
<span id="1301">1301</span>
<span id="1302">1302</span>
<span id="1303">1303</span>
<span id="1304">1304</span>
<span id="1305">1305</span>
<span id="1306">1306</span>
<span id="1307">1307</span>
<span id="1308">1308</span>
<span id="1309">1309</span>
<span id="1310">1310</span>
<span id="1311">1311</span>
<span id="1312">1312</span>
<span id="1313">1313</span>
<span id="1314">1314</span>
<span id="1315">1315</span>
<span id="1316">1316</span>
<span id="1317">1317</span>
<span id="1318">1318</span>
<span id="1319">1319</span>
<span id="1320">1320</span>
<span id="1321">1321</span>
<span id="1322">1322</span>
<span id="1323">1323</span>
<span id="1324">1324</span>
<span id="1325">1325</span>
<span id="1326">1326</span>
<span id="1327">1327</span>
<span id="1328">1328</span>
<span id="1329">1329</span>
<span id="1330">1330</span>
<span id="1331">1331</span>
<span id="1332">1332</span>
<span id="1333">1333</span>
<span id="1334">1334</span>
<span id="1335">1335</span>
<span id="1336">1336</span>
<span id="1337">1337</span>
<span id="1338">1338</span>
<span id="1339">1339</span>
<span id="1340">1340</span>
<span id="1341">1341</span>
<span id="1342">1342</span>
<span id="1343">1343</span>
<span id="1344">1344</span>
<span id="1345">1345</span>
<span id="1346">1346</span>
<span id="1347">1347</span>
<span id="1348">1348</span>
<span id="1349">1349</span>
<span id="1350">1350</span>
<span id="1351">1351</span>
<span id="1352">1352</span>
<span id="1353">1353</span>
<span id="1354">1354</span>
<span id="1355">1355</span>
<span id="1356">1356</span>
<span id="1357">1357</span>
<span id="1358">1358</span>
<span id="1359">1359</span>
<span id="1360">1360</span>
<span id="1361">1361</span>
<span id="1362">1362</span>
<span id="1363">1363</span>
<span id="1364">1364</span>
<span id="1365">1365</span>
<span id="1366">1366</span>
<span id="1367">1367</span>
<span id="1368">1368</span>
<span id="1369">1369</span>
<span id="1370">1370</span>
<span id="1371">1371</span>
<span id="1372">1372</span>
<span id="1373">1373</span>
<span id="1374">1374</span>
<span id="1375">1375</span>
<span id="1376">1376</span>
<span id="1377">1377</span>
<span id="1378">1378</span>
<span id="1379">1379</span>
<span id="1380">1380</span>
<span id="1381">1381</span>
<span id="1382">1382</span>
<span id="1383">1383</span>
<span id="1384">1384</span>
<span id="1385">1385</span>
<span id="1386">1386</span>
<span id="1387">1387</span>
<span id="1388">1388</span>
<span id="1389">1389</span>
<span id="1390">1390</span>
<span id="1391">1391</span>
<span id="1392">1392</span>
<span id="1393">1393</span>
<span id="1394">1394</span>
<span id="1395">1395</span>
<span id="1396">1396</span>
<span id="1397">1397</span>
<span id="1398">1398</span>
<span id="1399">1399</span>
<span id="1400">1400</span>
<span id="1401">1401</span>
<span id="1402">1402</span>
<span id="1403">1403</span>
<span id="1404">1404</span>
<span id="1405">1405</span>
<span id="1406">1406</span>
<span id="1407">1407</span>
<span id="1408">1408</span>
<span id="1409">1409</span>
<span id="1410">1410</span>
<span id="1411">1411</span>
<span id="1412">1412</span>
<span id="1413">1413</span>
<span id="1414">1414</span>
<span id="1415">1415</span>
<span id="1416">1416</span>
<span id="1417">1417</span>
<span id="1418">1418</span>
<span id="1419">1419</span>
<span id="1420">1420</span>
<span id="1421">1421</span>
<span id="1422">1422</span>
<span id="1423">1423</span>
<span id="1424">1424</span>
<span id="1425">1425</span>
<span id="1426">1426</span>
<span id="1427">1427</span>
<span id="1428">1428</span>
<span id="1429">1429</span>
<span id="1430">1430</span>
<span id="1431">1431</span>
<span id="1432">1432</span>
<span id="1433">1433</span>
<span id="1434">1434</span>
<span id="1435">1435</span>
<span id="1436">1436</span>
<span id="1437">1437</span>
<span id="1438">1438</span>
<span id="1439">1439</span>
<span id="1440">1440</span>
<span id="1441">1441</span>
<span id="1442">1442</span>
<span id="1443">1443</span>
<span id="1444">1444</span>
<span id="1445">1445</span>
<span id="1446">1446</span>
<span id="1447">1447</span>
<span id="1448">1448</span>
<span id="1449">1449</span>
<span id="1450">1450</span>
<span id="1451">1451</span>
<span id="1452">1452</span>
<span id="1453">1453</span>
<span id="1454">1454</span>
<span id="1455">1455</span>
<span id="1456">1456</span>
<span id="1457">1457</span>
<span id="1458">1458</span>
<span id="1459">1459</span>
<span id="1460">1460</span>
<span id="1461">1461</span>
<span id="1462">1462</span>
<span id="1463">1463</span>
<span id="1464">1464</span>
<span id="1465">1465</span>
<span id="1466">1466</span>
<span id="1467">1467</span>
<span id="1468">1468</span>
<span id="1469">1469</span>
<span id="1470">1470</span>
<span id="1471">1471</span>
<span id="1472">1472</span>
<span id="1473">1473</span>
<span id="1474">1474</span>
<span id="1475">1475</span>
<span id="1476">1476</span>
<span id="1477">1477</span>
<span id="1478">1478</span>
<span id="1479">1479</span>
<span id="1480">1480</span>
<span id="1481">1481</span>
<span id="1482">1482</span>
<span id="1483">1483</span>
<span id="1484">1484</span>
<span id="1485">1485</span>
<span id="1486">1486</span>
<span id="1487">1487</span>
<span id="1488">1488</span>
<span id="1489">1489</span>
<span id="1490">1490</span>
<span id="1491">1491</span>
<span id="1492">1492</span>
<span id="1493">1493</span>
<span id="1494">1494</span>
<span id="1495">1495</span>
<span id="1496">1496</span>
<span id="1497">1497</span>
<span id="1498">1498</span>
<span id="1499">1499</span>
<span id="1500">1500</span>
<span id="1501">1501</span>
<span id="1502">1502</span>
<span id="1503">1503</span>
<span id="1504">1504</span>
<span id="1505">1505</span>
<span id="1506">1506</span>
<span id="1507">1507</span>
<span id="1508">1508</span>
<span id="1509">1509</span>
<span id="1510">1510</span>
<span id="1511">1511</span>
<span id="1512">1512</span>
<span id="1513">1513</span>
<span id="1514">1514</span>
<span id="1515">1515</span>
<span id="1516">1516</span>
<span id="1517">1517</span>
<span id="1518">1518</span>
<span id="1519">1519</span>
<span id="1520">1520</span>
<span id="1521">1521</span>
<span id="1522">1522</span>
<span id="1523">1523</span>
<span id="1524">1524</span>
<span id="1525">1525</span>
<span id="1526">1526</span>
<span id="1527">1527</span>
<span id="1528">1528</span>
<span id="1529">1529</span>
<span id="1530">1530</span>
<span id="1531">1531</span>
<span id="1532">1532</span>
<span id="1533">1533</span>
<span id="1534">1534</span>
<span id="1535">1535</span>
<span id="1536">1536</span>
<span id="1537">1537</span>
<span id="1538">1538</span>
<span id="1539">1539</span>
<span id="1540">1540</span>
<span id="1541">1541</span>
<span id="1542">1542</span>
<span id="1543">1543</span>
<span id="1544">1544</span>
<span id="1545">1545</span>
<span id="1546">1546</span>
<span id="1547">1547</span>
<span id="1548">1548</span>
<span id="1549">1549</span>
<span id="1550">1550</span>
<span id="1551">1551</span>
<span id="1552">1552</span>
<span id="1553">1553</span>
<span id="1554">1554</span>
<span id="1555">1555</span>
<span id="1556">1556</span>
<span id="1557">1557</span>
<span id="1558">1558</span>
<span id="1559">1559</span>
<span id="1560">1560</span>
<span id="1561">1561</span>
<span id="1562">1562</span>
<span id="1563">1563</span>
<span id="1564">1564</span>
<span id="1565">1565</span>
<span id="1566">1566</span>
<span id="1567">1567</span>
<span id="1568">1568</span>
<span id="1569">1569</span>
<span id="1570">1570</span>
<span id="1571">1571</span>
<span id="1572">1572</span>
<span id="1573">1573</span>
<span id="1574">1574</span>
<span id="1575">1575</span>
<span id="1576">1576</span>
<span id="1577">1577</span>
<span id="1578">1578</span>
<span id="1579">1579</span>
<span id="1580">1580</span>
<span id="1581">1581</span>
<span id="1582">1582</span>
<span id="1583">1583</span>
<span id="1584">1584</span>
<span id="1585">1585</span>
<span id="1586">1586</span>
<span id="1587">1587</span>
<span id="1588">1588</span>
<span id="1589">1589</span>
<span id="1590">1590</span>
<span id="1591">1591</span>
<span id="1592">1592</span>
<span id="1593">1593</span>
<span id="1594">1594</span>
<span id="1595">1595</span>
<span id="1596">1596</span>
<span id="1597">1597</span>
<span id="1598">1598</span>
<span id="1599">1599</span>
<span id="1600">1600</span>
<span id="1601">1601</span>
<span id="1602">1602</span>
<span id="1603">1603</span>
<span id="1604">1604</span>
<span id="1605">1605</span>
<span id="1606">1606</span>
<span id="1607">1607</span>
<span id="1608">1608</span>
<span id="1609">1609</span>
<span id="1610">1610</span>
<span id="1611">1611</span>
<span id="1612">1612</span>
<span id="1613">1613</span>
<span id="1614">1614</span>
<span id="1615">1615</span>
<span id="1616">1616</span>
<span id="1617">1617</span>
<span id="1618">1618</span>
<span id="1619">1619</span>
<span id="1620">1620</span>
<span id="1621">1621</span>
<span id="1622">1622</span>
<span id="1623">1623</span>
<span id="1624">1624</span>
<span id="1625">1625</span>
<span id="1626">1626</span>
<span id="1627">1627</span>
<span id="1628">1628</span>
<span id="1629">1629</span>
<span id="1630">1630</span>
<span id="1631">1631</span>
<span id="1632">1632</span>
<span id="1633">1633</span>
<span id="1634">1634</span>
<span id="1635">1635</span>
<span id="1636">1636</span>
<span id="1637">1637</span>
<span id="1638">1638</span>
<span id="1639">1639</span>
<span id="1640">1640</span>
<span id="1641">1641</span>
<span id="1642">1642</span>
<span id="1643">1643</span>
<span id="1644">1644</span>
<span id="1645">1645</span>
<span id="1646">1646</span>
<span id="1647">1647</span>
<span id="1648">1648</span>
<span id="1649">1649</span>
<span id="1650">1650</span>
<span id="1651">1651</span>
<span id="1652">1652</span>
<span id="1653">1653</span>
<span id="1654">1654</span>
<span id="1655">1655</span>
<span id="1656">1656</span>
<span id="1657">1657</span>
<span id="1658">1658</span>
<span id="1659">1659</span>
<span id="1660">1660</span>
<span id="1661">1661</span>
<span id="1662">1662</span>
<span id="1663">1663</span>
<span id="1664">1664</span>
<span id="1665">1665</span>
<span id="1666">1666</span>
<span id="1667">1667</span>
<span id="1668">1668</span>
<span id="1669">1669</span>
<span id="1670">1670</span>
<span id="1671">1671</span>
<span id="1672">1672</span>
<span id="1673">1673</span>
<span id="1674">1674</span>
<span id="1675">1675</span>
<span id="1676">1676</span>
<span id="1677">1677</span>
<span id="1678">1678</span>
<span id="1679">1679</span>
<span id="1680">1680</span>
<span id="1681">1681</span>
<span id="1682">1682</span>
<span id="1683">1683</span>
<span id="1684">1684</span>
<span id="1685">1685</span>
<span id="1686">1686</span>
<span id="1687">1687</span>
<span id="1688">1688</span>
<span id="1689">1689</span>
<span id="1690">1690</span>
<span id="1691">1691</span>
<span id="1692">1692</span>
<span id="1693">1693</span>
<span id="1694">1694</span>
<span id="1695">1695</span>
<span id="1696">1696</span>
<span id="1697">1697</span>
<span id="1698">1698</span>
<span id="1699">1699</span>
<span id="1700">1700</span>
<span id="1701">1701</span>
<span id="1702">1702</span>
<span id="1703">1703</span>
<span id="1704">1704</span>
<span id="1705">1705</span>
<span id="1706">1706</span>
<span id="1707">1707</span>
<span id="1708">1708</span>
<span id="1709">1709</span>
<span id="1710">1710</span>
<span id="1711">1711</span>
<span id="1712">1712</span>
<span id="1713">1713</span>
<span id="1714">1714</span>
<span id="1715">1715</span>
<span id="1716">1716</span>
<span id="1717">1717</span>
<span id="1718">1718</span>
<span id="1719">1719</span>
<span id="1720">1720</span>
<span id="1721">1721</span>
<span id="1722">1722</span>
<span id="1723">1723</span>
<span id="1724">1724</span>
<span id="1725">1725</span>
<span id="1726">1726</span>
<span id="1727">1727</span>
<span id="1728">1728</span>
<span id="1729">1729</span>
<span id="1730">1730</span>
<span id="1731">1731</span>
<span id="1732">1732</span>
<span id="1733">1733</span>
<span id="1734">1734</span>
<span id="1735">1735</span>
<span id="1736">1736</span>
<span id="1737">1737</span>
<span id="1738">1738</span>
<span id="1739">1739</span>
<span id="1740">1740</span>
<span id="1741">1741</span>
<span id="1742">1742</span>
</pre><pre class="rust"><code><span class="comment">//</span>
<span class="comment">// Copyright 2020-2021 Signal Messenger, LLC.</span>
<span class="comment">// SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="comment">//</span>

<span class="kw">use</span> <span class="kw">crate</span>::{
    <span class="ident">message_encrypt</span>, <span class="ident">CiphertextMessageType</span>, <span class="ident">Context</span>, <span class="ident">Direction</span>, <span class="ident">IdentityKey</span>, <span class="ident">IdentityKeyPair</span>,
    <span class="ident">IdentityKeyStore</span>, <span class="ident">KeyPair</span>, <span class="ident">PreKeySignalMessage</span>, <span class="ident">PreKeyStore</span>, <span class="ident">PrivateKey</span>, <span class="ident">ProtocolAddress</span>,
    <span class="ident">PublicKey</span>, <span class="prelude-ty">Result</span>, <span class="ident">SessionRecord</span>, <span class="ident">SessionStore</span>, <span class="ident">SignalMessage</span>, <span class="ident">SignalProtocolError</span>,
    <span class="ident">SignedPreKeyStore</span>,
};

<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::crypto</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::curve</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::proto</span>;
<span class="kw">use</span> <span class="ident"><span class="kw">crate</span>::session_cipher</span>;

<span class="kw">use</span> <span class="ident">aes_gcm_siv::aead</span>::{<span class="ident">AeadInPlace</span>, <span class="ident">NewAead</span>};
<span class="kw">use</span> <span class="ident">aes_gcm_siv::Aes256GcmSiv</span>;
<span class="kw">use</span> <span class="ident">arrayref::array_ref</span>;
<span class="kw">use</span> <span class="ident">curve25519_dalek::scalar::Scalar</span>;
<span class="kw">use</span> <span class="ident">prost::Message</span>;
<span class="kw">use</span> <span class="ident">rand</span>::{<span class="ident">CryptoRng</span>, <span class="ident">Rng</span>};
<span class="kw">use</span> <span class="ident">subtle::ConstantTimeEq</span>;
<span class="kw">use</span> <span class="ident">uuid::Uuid</span>;

<span class="kw">use</span> <span class="ident">proto::sealed_sender::unidentified_sender_message::message::Type</span> <span class="kw">as</span> <span class="ident">ProtoMessageType</span>;

<span class="kw">use</span> <span class="ident">std::convert</span>::{<span class="ident">TryFrom</span>, <span class="ident">TryInto</span>};

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Debug</span>, <span class="ident">Clone</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">ServerCertificate</span> {
    <span class="ident">serialized</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    <span class="ident">key_id</span>: <span class="ident">u32</span>,
    <span class="ident">key</span>: <span class="ident">PublicKey</span>,
    <span class="ident">certificate</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    <span class="ident">signature</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
}

<span class="comment">/*
0xDEADC357 is a server certificate ID which is used to test the
revocation logic. As of this writing, no prod server certificates have
been revoked. If one ever does, add its key ID here.

If a production server certificate is ever generated which collides
with this test certificate ID, Bad Things will happen.
*/</span>
<span class="kw">const</span> <span class="ident">REVOKED_SERVER_CERTIFICATE_KEY_IDS</span>: <span class="kw-2">&amp;</span>[<span class="ident">u32</span>] <span class="op">=</span> <span class="kw-2">&amp;</span>[<span class="number">0xDEADC357</span>];

<span class="kw">impl</span> <span class="ident">ServerCertificate</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">deserialize</span>(<span class="ident">data</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::ServerCertificate::decode</span>(<span class="ident">data</span>)
            .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;

        <span class="kw">if</span> <span class="ident">pb</span>.<span class="ident">certificate</span>.<span class="ident">is_none</span>() <span class="op">|</span><span class="op">|</span> <span class="ident">pb</span>.<span class="ident">signature</span>.<span class="ident">is_none</span>() {
            <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>);
        }

        <span class="kw">let</span> <span class="ident">certificate</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">certificate</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">signature</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">signature</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">certificate_data</span> <span class="op">=</span>
            <span class="ident">proto::sealed_sender::server_certificate::Certificate::decode</span>(<span class="ident">certificate</span>.<span class="ident">as_ref</span>())
                .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">PublicKey::try_from</span>(
            <span class="kw-2">&amp;</span><span class="ident">certificate_data</span>
                .<span class="ident">key</span>
                .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>[..],
        )<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">key_id</span> <span class="op">=</span> <span class="ident">certificate_data</span>
            .<span class="ident">id</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">serialized</span>: <span class="ident">data</span>.<span class="ident">to_vec</span>(),
            <span class="ident">certificate</span>,
            <span class="ident">signature</span>,
            <span class="ident">key</span>,
            <span class="ident">key_id</span>,
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span><span class="op">&lt;</span><span class="ident">R</span>: <span class="ident">Rng</span> <span class="op">+</span> <span class="ident">CryptoRng</span><span class="op">&gt;</span>(
        <span class="ident">key_id</span>: <span class="ident">u32</span>,
        <span class="ident">key</span>: <span class="ident">PublicKey</span>,
        <span class="ident">trust_root</span>: <span class="kw-2">&amp;</span><span class="ident">PrivateKey</span>,
        <span class="ident">rng</span>: <span class="kw-2">&amp;mut</span> <span class="ident">R</span>,
    ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">certificate_pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::server_certificate::Certificate</span> {
            <span class="ident">id</span>: <span class="prelude-val">Some</span>(<span class="ident">key_id</span>),
            <span class="ident">key</span>: <span class="prelude-val">Some</span>(<span class="ident">key</span>.<span class="ident">serialize</span>().<span class="ident">to_vec</span>()),
        };

        <span class="kw">let</span> <span class="ident">certificate</span> <span class="op">=</span> <span class="ident">certificate_pb</span>.<span class="ident">encode_to_vec</span>();

        <span class="kw">let</span> <span class="ident">signature</span> <span class="op">=</span> <span class="ident">trust_root</span>.<span class="ident">calculate_signature</span>(<span class="kw-2">&amp;</span><span class="ident">certificate</span>, <span class="ident">rng</span>)<span class="question-mark">?</span>.<span class="ident">to_vec</span>();

        <span class="kw">let</span> <span class="ident">serialized</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::ServerCertificate</span> {
            <span class="ident">certificate</span>: <span class="prelude-val">Some</span>(<span class="ident">certificate</span>.<span class="ident">clone</span>()),
            <span class="ident">signature</span>: <span class="prelude-val">Some</span>(<span class="ident">signature</span>.<span class="ident">clone</span>()),
        }
        .<span class="ident">encode_to_vec</span>();

        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">serialized</span>,
            <span class="ident">certificate</span>,
            <span class="ident">signature</span>,
            <span class="ident">key</span>,
            <span class="ident">key_id</span>,
        })
    }

    <span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn</span> <span class="ident">to_protobuf</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">proto::sealed_sender::ServerCertificate</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="ident">proto::sealed_sender::ServerCertificate</span> {
            <span class="ident">certificate</span>: <span class="prelude-val">Some</span>(<span class="self">self</span>.<span class="ident">certificate</span>.<span class="ident">clone</span>()),
            <span class="ident">signature</span>: <span class="prelude-val">Some</span>(<span class="self">self</span>.<span class="ident">signature</span>.<span class="ident">clone</span>()),
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">validate</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">trust_root</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">bool</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="ident">REVOKED_SERVER_CERTIFICATE_KEY_IDS</span>.<span class="ident">contains</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">key_id</span>()<span class="question-mark">?</span>) {
            <span class="macro">log::error!</span>(
                <span class="string">&quot;received server certificate with revoked ID {:x}&quot;</span>,
                <span class="self">self</span>.<span class="ident">key_id</span>()<span class="question-mark">?</span>
            );
            <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="bool-val">false</span>);
        }
        <span class="ident">trust_root</span>.<span class="ident">verify_signature</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">certificate</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">signature</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">key_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">key_id</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">public_key</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">PublicKey</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">key</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">certificate</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">certificate</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">signature</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">signature</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">serialized</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">serialized</span>)
    }
}

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Debug</span>, <span class="ident">Clone</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">SenderCertificate</span> {
    <span class="ident">signer</span>: <span class="ident">ServerCertificate</span>,
    <span class="ident">key</span>: <span class="ident">PublicKey</span>,
    <span class="ident">sender_device_id</span>: <span class="ident">u32</span>,
    <span class="ident">sender_uuid</span>: <span class="ident">String</span>,
    <span class="ident">sender_e164</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
    <span class="ident">expiration</span>: <span class="ident">u64</span>,
    <span class="ident">serialized</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    <span class="ident">certificate</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    <span class="ident">signature</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
}

<span class="kw">impl</span> <span class="ident">SenderCertificate</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">deserialize</span>(<span class="ident">data</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::SenderCertificate::decode</span>(<span class="ident">data</span>)
            .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">certificate</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">certificate</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">signature</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">signature</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">certificate_data</span> <span class="op">=</span>
            <span class="ident">proto::sealed_sender::sender_certificate::Certificate::decode</span>(<span class="ident">certificate</span>.<span class="ident">as_ref</span>())
                .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">sender_device_id</span> <span class="op">=</span> <span class="ident">certificate_data</span>
            .<span class="ident">sender_device</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">expiration</span> <span class="op">=</span> <span class="ident">certificate_data</span>
            .<span class="ident">expires</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">signer_pb</span> <span class="op">=</span> <span class="ident">certificate_data</span>
            .<span class="ident">signer</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">sender_uuid</span> <span class="op">=</span> <span class="ident">certificate_data</span>
            .<span class="ident">sender_uuid</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">sender_e164</span> <span class="op">=</span> <span class="ident">certificate_data</span>.<span class="ident">sender_e164</span>;

        <span class="kw">let</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">PublicKey::try_from</span>(
            <span class="kw-2">&amp;</span><span class="ident">certificate_data</span>
                .<span class="ident">identity_key</span>
                .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>[..],
        )<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">signer_bits</span> <span class="op">=</span> <span class="ident">signer_pb</span>.<span class="ident">encode_to_vec</span>();
        <span class="kw">let</span> <span class="ident">signer</span> <span class="op">=</span> <span class="ident">ServerCertificate::deserialize</span>(<span class="kw-2">&amp;</span><span class="ident">signer_bits</span>)<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">signer</span>,
            <span class="ident">key</span>,
            <span class="ident">sender_device_id</span>,
            <span class="ident">sender_uuid</span>,
            <span class="ident">sender_e164</span>,
            <span class="ident">expiration</span>,
            <span class="ident">serialized</span>: <span class="ident">data</span>.<span class="ident">to_vec</span>(),
            <span class="ident">certificate</span>,
            <span class="ident">signature</span>,
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span><span class="op">&lt;</span><span class="ident">R</span>: <span class="ident">Rng</span> <span class="op">+</span> <span class="ident">CryptoRng</span><span class="op">&gt;</span>(
        <span class="ident">sender_uuid</span>: <span class="ident">String</span>,
        <span class="ident">sender_e164</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
        <span class="ident">key</span>: <span class="ident">PublicKey</span>,
        <span class="ident">sender_device_id</span>: <span class="ident">u32</span>,
        <span class="ident">expiration</span>: <span class="ident">u64</span>,
        <span class="ident">signer</span>: <span class="ident">ServerCertificate</span>,
        <span class="ident">signer_key</span>: <span class="kw-2">&amp;</span><span class="ident">PrivateKey</span>,
        <span class="ident">rng</span>: <span class="kw-2">&amp;mut</span> <span class="ident">R</span>,
    ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">certificate_pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::sender_certificate::Certificate</span> {
            <span class="ident">sender_uuid</span>: <span class="prelude-val">Some</span>(<span class="ident">sender_uuid</span>.<span class="ident">clone</span>()),
            <span class="ident">sender_e164</span>: <span class="ident">sender_e164</span>.<span class="ident">clone</span>(),
            <span class="ident">sender_device</span>: <span class="prelude-val">Some</span>(<span class="ident">sender_device_id</span>),
            <span class="ident">expires</span>: <span class="prelude-val">Some</span>(<span class="ident">expiration</span>),
            <span class="ident">identity_key</span>: <span class="prelude-val">Some</span>(<span class="ident">key</span>.<span class="ident">serialize</span>().<span class="ident">to_vec</span>()),
            <span class="ident">signer</span>: <span class="prelude-val">Some</span>(<span class="ident">signer</span>.<span class="ident">to_protobuf</span>()<span class="question-mark">?</span>),
        };

        <span class="kw">let</span> <span class="ident">certificate</span> <span class="op">=</span> <span class="ident">certificate_pb</span>.<span class="ident">encode_to_vec</span>();

        <span class="kw">let</span> <span class="ident">signature</span> <span class="op">=</span> <span class="ident">signer_key</span>.<span class="ident">calculate_signature</span>(<span class="kw-2">&amp;</span><span class="ident">certificate</span>, <span class="ident">rng</span>)<span class="question-mark">?</span>.<span class="ident">to_vec</span>();

        <span class="kw">let</span> <span class="ident">serialized</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::SenderCertificate</span> {
            <span class="ident">certificate</span>: <span class="prelude-val">Some</span>(<span class="ident">certificate</span>.<span class="ident">clone</span>()),
            <span class="ident">signature</span>: <span class="prelude-val">Some</span>(<span class="ident">signature</span>.<span class="ident">clone</span>()),
        }
        .<span class="ident">encode_to_vec</span>();

        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">signer</span>,
            <span class="ident">key</span>,
            <span class="ident">sender_device_id</span>,
            <span class="ident">sender_uuid</span>,
            <span class="ident">sender_e164</span>,
            <span class="ident">expiration</span>,
            <span class="ident">serialized</span>,
            <span class="ident">certificate</span>,
            <span class="ident">signature</span>,
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">validate</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">trust_root</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>, <span class="ident">validation_time</span>: <span class="ident">u64</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">bool</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="op">!</span><span class="self">self</span>.<span class="ident">signer</span>.<span class="ident">validate</span>(<span class="ident">trust_root</span>)<span class="question-mark">?</span> {
            <span class="macro">log::error!</span>(<span class="string">&quot;received server certificate not signed by trust root&quot;</span>);
            <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="bool-val">false</span>);
        }

        <span class="kw">if</span> <span class="op">!</span><span class="self">self</span>
            .<span class="ident">signer</span>
            .<span class="ident">public_key</span>()<span class="question-mark">?</span>
            .<span class="ident">verify_signature</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">certificate</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">signature</span>)<span class="question-mark">?</span>
        {
            <span class="macro">log::error!</span>(<span class="string">&quot;received sender certificate not signed by server&quot;</span>);
            <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="bool-val">false</span>);
        }

        <span class="kw">if</span> <span class="ident">validation_time</span> <span class="op">&gt;</span> <span class="self">self</span>.<span class="ident">expiration</span> {
            <span class="macro">log::error!</span>(
                <span class="string">&quot;received expired sender certificate (expiration: {}, validation_time: {})&quot;</span>,
                <span class="self">self</span>.<span class="ident">expiration</span>,
                <span class="ident">validation_time</span>
            );
            <span class="kw">return</span> <span class="prelude-val">Ok</span>(<span class="bool-val">false</span>);
        }

        <span class="prelude-val">Ok</span>(<span class="bool-val">true</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">signer</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">ServerCertificate</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">signer</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">key</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">PublicKey</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">key</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sender_device_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">sender_device_id</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sender_uuid</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">str</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">sender_uuid</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sender_e164</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">str</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">sender_e164</span>.<span class="ident">as_deref</span>())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">expiration</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">u64</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">expiration</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">serialized</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">serialized</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">certificate</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">certificate</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">signature</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">signature</span>)
    }
}

<span class="kw">impl</span> <span class="ident">From</span><span class="op">&lt;</span><span class="ident">ProtoMessageType</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">CiphertextMessageType</span> {
    <span class="kw">fn</span> <span class="ident">from</span>(<span class="ident">message_type</span>: <span class="ident">ProtoMessageType</span>) -&gt; <span class="self">Self</span> {
        <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">message_type</span> {
            <span class="ident">ProtoMessageType::Message</span> =&gt; <span class="ident"><span class="self">Self</span>::Whisper</span>,
            <span class="ident">ProtoMessageType::PrekeyMessage</span> =&gt; <span class="ident"><span class="self">Self</span>::PreKey</span>,
            <span class="ident">ProtoMessageType::SenderkeyMessage</span> =&gt; <span class="ident"><span class="self">Self</span>::SenderKey</span>,
            <span class="ident">ProtoMessageType::PlaintextContent</span> =&gt; <span class="ident"><span class="self">Self</span>::Plaintext</span>,
        };
        <span class="comment">// Keep raw values in sync from now on, for efficient codegen.</span>
        <span class="macro">assert!</span>(<span class="ident">result</span> <span class="op">==</span> <span class="ident"><span class="self">Self</span>::PreKey</span> <span class="op">|</span><span class="op">|</span> <span class="ident">message_type</span> <span class="kw">as</span> <span class="ident">i32</span> <span class="op">==</span> <span class="ident">result</span> <span class="kw">as</span> <span class="ident">i32</span>);
        <span class="ident">result</span>
    }
}

<span class="kw">impl</span> <span class="ident">From</span><span class="op">&lt;</span><span class="ident">CiphertextMessageType</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">ProtoMessageType</span> {
    <span class="kw">fn</span> <span class="ident">from</span>(<span class="ident">message_type</span>: <span class="ident">CiphertextMessageType</span>) -&gt; <span class="self">Self</span> {
        <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">message_type</span> {
            <span class="ident">CiphertextMessageType::PreKey</span> =&gt; <span class="ident"><span class="self">Self</span>::PrekeyMessage</span>,
            <span class="ident">CiphertextMessageType::Whisper</span> =&gt; <span class="ident"><span class="self">Self</span>::Message</span>,
            <span class="ident">CiphertextMessageType::SenderKey</span> =&gt; <span class="ident"><span class="self">Self</span>::SenderkeyMessage</span>,
            <span class="ident">CiphertextMessageType::Plaintext</span> =&gt; <span class="ident"><span class="self">Self</span>::PlaintextContent</span>,
        };
        <span class="comment">// Keep raw values in sync from now on, for efficient codegen.</span>
        <span class="macro">assert!</span>(<span class="ident">result</span> <span class="op">==</span> <span class="ident"><span class="self">Self</span>::PrekeyMessage</span> <span class="op">|</span><span class="op">|</span> <span class="ident">message_type</span> <span class="kw">as</span> <span class="ident">i32</span> <span class="op">==</span> <span class="ident">result</span> <span class="kw">as</span> <span class="ident">i32</span>);
        <span class="ident">result</span>
    }
}

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Clone</span>, <span class="ident">Copy</span>, <span class="ident">PartialEq</span>, <span class="ident">Eq</span>, <span class="ident">Debug</span>)]</span>
<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">ContentHint</span> {
    <span class="ident">Default</span>,
    <span class="ident">Resendable</span>,
    <span class="ident">Implicit</span>,
    <span class="ident">Unknown</span>(<span class="ident">u32</span>),
}

<span class="kw">impl</span> <span class="ident">ContentHint</span> {
    <span class="kw">fn</span> <span class="ident">to_proto</span>(<span class="self">self</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">i32</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="self">self</span> <span class="op">==</span> <span class="ident">ContentHint::Default</span> {
            <span class="prelude-val">None</span>
        } <span class="kw">else</span> {
            <span class="prelude-val">Some</span>(<span class="ident">u32::from</span>(<span class="self">self</span>) <span class="kw">as</span> <span class="ident">i32</span>)
        }
    }

    <span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">to_u32</span>(<span class="self">self</span>) -&gt; <span class="ident">u32</span> {
        <span class="kw">use</span> <span class="ident">proto::sealed_sender::unidentified_sender_message::message::ContentHint</span> <span class="kw">as</span> <span class="ident">ProtoContentHint</span>;
        <span class="kw">match</span> <span class="self">self</span> {
            <span class="ident">ContentHint::Default</span> =&gt; <span class="number">0</span>,
            <span class="ident">ContentHint::Resendable</span> =&gt; <span class="ident">ProtoContentHint::Resendable</span> <span class="kw">as</span> <span class="ident">u32</span>,
            <span class="ident">ContentHint::Implicit</span> =&gt; <span class="ident">ProtoContentHint::Implicit</span> <span class="kw">as</span> <span class="ident">u32</span>,
            <span class="ident">ContentHint::Unknown</span>(<span class="ident">value</span>) =&gt; <span class="ident">value</span>,
        }
    }
}

<span class="kw">impl</span> <span class="ident">From</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">ContentHint</span> {
    <span class="kw">fn</span> <span class="ident">from</span>(<span class="ident">raw_value</span>: <span class="ident">u32</span>) -&gt; <span class="self">Self</span> {
        <span class="kw">use</span> <span class="ident">proto::sealed_sender::unidentified_sender_message::message::ContentHint</span> <span class="kw">as</span> <span class="ident">ProtoContentHint</span>;
        <span class="macro">assert!</span>(<span class="op">!</span><span class="ident">ProtoContentHint::is_valid</span>(<span class="number">0</span>));
        <span class="kw">match</span> <span class="ident">ProtoContentHint::from_i32</span>(<span class="ident">raw_value</span> <span class="kw">as</span> <span class="ident">i32</span>) {
            <span class="prelude-val">None</span> <span class="kw">if</span> <span class="ident">raw_value</span> <span class="op">==</span> <span class="number">0</span> =&gt; <span class="ident">ContentHint::Default</span>,
            <span class="prelude-val">None</span> =&gt; <span class="ident">ContentHint::Unknown</span>(<span class="ident">raw_value</span>),
            <span class="prelude-val">Some</span>(<span class="ident">ProtoContentHint::Resendable</span>) =&gt; <span class="ident">ContentHint::Resendable</span>,
            <span class="prelude-val">Some</span>(<span class="ident">ProtoContentHint::Implicit</span>) =&gt; <span class="ident">ContentHint::Implicit</span>,
        }
    }
}

<span class="kw">impl</span> <span class="ident">From</span><span class="op">&lt;</span><span class="ident">ContentHint</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">u32</span> {
    <span class="kw">fn</span> <span class="ident">from</span>(<span class="ident">hint</span>: <span class="ident">ContentHint</span>) -&gt; <span class="self">Self</span> {
        <span class="ident">hint</span>.<span class="ident">to_u32</span>()
    }
}
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">UnidentifiedSenderMessageContent</span> {
    <span class="ident">serialized</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    <span class="ident">contents</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    <span class="ident">sender</span>: <span class="ident">SenderCertificate</span>,
    <span class="ident">msg_type</span>: <span class="ident">CiphertextMessageType</span>,
    <span class="ident">content_hint</span>: <span class="ident">ContentHint</span>,
    <span class="ident">group_id</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span>,
}

<span class="kw">impl</span> <span class="ident">UnidentifiedSenderMessageContent</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">deserialize</span>(<span class="ident">data</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::unidentified_sender_message::Message::decode</span>(<span class="ident">data</span>)
            .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">msg_type</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">r#type</span>
            .<span class="ident">and_then</span>(<span class="ident">ProtoMessageType::from_i32</span>)
            .<span class="ident">map</span>(<span class="ident">CiphertextMessageType::from</span>)
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">sender</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">sender_certificate</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">contents</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">content</span>
            .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">content_hint</span> <span class="op">=</span> <span class="ident">pb</span>
            .<span class="ident">content_hint</span>
            .<span class="ident">map</span>(<span class="op">|</span><span class="ident">raw</span><span class="op">|</span> <span class="ident">ContentHint::from</span>(<span class="ident">raw</span> <span class="kw">as</span> <span class="ident">u32</span>))
            .<span class="ident">unwrap_or</span>(<span class="ident">ContentHint::Default</span>);
        <span class="kw">let</span> <span class="ident">group_id</span> <span class="op">=</span> <span class="ident">pb</span>.<span class="ident">group_id</span>;

        <span class="kw">let</span> <span class="ident">sender</span> <span class="op">=</span> <span class="ident">SenderCertificate::deserialize</span>(<span class="kw-2">&amp;</span><span class="ident">sender</span>)<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">serialized</span> <span class="op">=</span> <span class="ident">data</span>.<span class="ident">to_vec</span>();

        <span class="macro">log::info!</span>(
            <span class="string">&quot;deserialized UnidentifiedSenderMessageContent from {}.{} with type {:?}&quot;</span>,
            <span class="ident">sender</span>.<span class="ident">sender_uuid</span>()<span class="question-mark">?</span>,
            <span class="ident">sender</span>.<span class="ident">sender_device_id</span>()<span class="question-mark">?</span>,
            <span class="ident">msg_type</span>,
        );

        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">serialized</span>,
            <span class="ident">contents</span>,
            <span class="ident">sender</span>,
            <span class="ident">msg_type</span>,
            <span class="ident">content_hint</span>,
            <span class="ident">group_id</span>,
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">new</span>(
        <span class="ident">msg_type</span>: <span class="ident">CiphertextMessageType</span>,
        <span class="ident">sender</span>: <span class="ident">SenderCertificate</span>,
        <span class="ident">contents</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
        <span class="ident">content_hint</span>: <span class="ident">ContentHint</span>,
        <span class="ident">group_id</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span>,
    ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">proto_msg_type</span> <span class="op">=</span> <span class="ident">ProtoMessageType::from</span>(<span class="ident">msg_type</span>);
        <span class="kw">let</span> <span class="ident">msg</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::unidentified_sender_message::Message</span> {
            <span class="ident">content</span>: <span class="prelude-val">Some</span>(<span class="ident">contents</span>.<span class="ident">clone</span>()),
            <span class="ident">r#type</span>: <span class="prelude-val">Some</span>(<span class="ident">proto_msg_type</span>.<span class="ident">into</span>()),
            <span class="ident">sender_certificate</span>: <span class="prelude-val">Some</span>(<span class="ident">sender</span>.<span class="ident">serialized</span>()<span class="question-mark">?</span>.<span class="ident">to_vec</span>()),
            <span class="ident">content_hint</span>: <span class="ident">content_hint</span>.<span class="ident">to_proto</span>(),
            <span class="ident">group_id</span>: <span class="ident">group_id</span>.<span class="ident">as_ref</span>().<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">buf</span><span class="op">|</span> {
                <span class="kw">if</span> <span class="ident">buf</span>.<span class="ident">is_empty</span>() {
                    <span class="prelude-val">None</span>
                } <span class="kw">else</span> {
                    <span class="prelude-val">Some</span>(<span class="ident">buf</span>.<span class="ident">clone</span>())
                }
            }),
        };

        <span class="kw">let</span> <span class="ident">serialized</span> <span class="op">=</span> <span class="ident">msg</span>.<span class="ident">encode_to_vec</span>();

        <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
            <span class="ident">serialized</span>,
            <span class="ident">msg_type</span>,
            <span class="ident">sender</span>,
            <span class="ident">contents</span>,
            <span class="ident">content_hint</span>,
            <span class="ident">group_id</span>,
        })
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">msg_type</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">CiphertextMessageType</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">msg_type</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sender</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">SenderCertificate</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">sender</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">contents</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">contents</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">content_hint</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">ContentHint</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">content_hint</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">group_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">group_id</span>.<span class="ident">as_deref</span>())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">serialized</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">serialized</span>)
    }
}

<span class="kw">enum</span> <span class="ident">UnidentifiedSenderMessage</span> {
    <span class="ident">V1</span> {
        <span class="ident">ephemeral_public</span>: <span class="ident">PublicKey</span>,
        <span class="ident">encrypted_static</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
        <span class="ident">encrypted_message</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
    },
    <span class="ident">V2</span> {
        <span class="ident">ephemeral_public</span>: <span class="ident">PublicKey</span>,
        <span class="ident">encrypted_message_key</span>: <span class="ident">Box</span><span class="op">&lt;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span>,
        <span class="ident">authentication_tag</span>: <span class="ident">Box</span><span class="op">&lt;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span>,
        <span class="ident">encrypted_message</span>: <span class="ident">Box</span><span class="op">&lt;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span>,
    },
}

<span class="kw">const</span> <span class="ident">SEALED_SENDER_V1_VERSION</span>: <span class="ident">u8</span> <span class="op">=</span> <span class="number">1</span>;
<span class="kw">const</span> <span class="ident">SEALED_SENDER_V2_VERSION</span>: <span class="ident">u8</span> <span class="op">=</span> <span class="number">2</span>;

<span class="kw">impl</span> <span class="ident">UnidentifiedSenderMessage</span> {
    <span class="kw">fn</span> <span class="ident">deserialize</span>(<span class="ident">data</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="ident">data</span>.<span class="ident">is_empty</span>() {
            <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
                <span class="string">&quot;Message was empty&quot;</span>.<span class="ident">to_owned</span>(),
            ));
        }
        <span class="kw">let</span> <span class="ident">version</span> <span class="op">=</span> <span class="ident">data</span>[<span class="number">0</span>] <span class="op">&gt;</span><span class="op">&gt;</span> <span class="number">4</span>;
        <span class="macro">log::debug!</span>(
            <span class="string">&quot;deserializing UnidentifiedSenderMessage with version {}&quot;</span>,
            <span class="ident">version</span>
        );

        <span class="kw">match</span> <span class="ident">version</span> {
            <span class="number">0</span> <span class="op">|</span> <span class="ident">SEALED_SENDER_V1_VERSION</span> =&gt; {
                <span class="comment">// XXX should we really be accepted version == 0 here?</span>
                <span class="kw">let</span> <span class="ident">pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::UnidentifiedSenderMessage::decode</span>(<span class="kw-2">&amp;</span><span class="ident">data</span>[<span class="number">1</span>..])
                    .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;

                <span class="kw">let</span> <span class="ident">ephemeral_public</span> <span class="op">=</span> <span class="ident">pb</span>
                    .<span class="ident">ephemeral_public</span>
                    .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
                <span class="kw">let</span> <span class="ident">encrypted_static</span> <span class="op">=</span> <span class="ident">pb</span>
                    .<span class="ident">encrypted_static</span>
                    .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
                <span class="kw">let</span> <span class="ident">encrypted_message</span> <span class="op">=</span> <span class="ident">pb</span>
                    .<span class="ident">encrypted_message</span>
                    .<span class="ident">ok_or</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;

                <span class="kw">let</span> <span class="ident">ephemeral_public</span> <span class="op">=</span> <span class="ident">PublicKey::try_from</span>(<span class="kw-2">&amp;</span><span class="ident">ephemeral_public</span>[..])<span class="question-mark">?</span>;

                <span class="prelude-val">Ok</span>(<span class="ident"><span class="self">Self</span>::V1</span> {
                    <span class="ident">ephemeral_public</span>,
                    <span class="ident">encrypted_static</span>,
                    <span class="ident">encrypted_message</span>,
                })
            }
            <span class="ident">SEALED_SENDER_V2_VERSION</span> =&gt; {
                <span class="comment">// Uses a flat representation: C || AT || E.pub || ciphertext</span>
                <span class="kw">let</span> <span class="ident">remaining</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">data</span>[<span class="number">1</span>..];
                <span class="kw">if</span> <span class="ident">remaining</span>.<span class="ident">len</span>()
                    <span class="op">&lt;</span> <span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span>
                        <span class="op">+</span> <span class="ident">sealed_sender_v2::AUTH_TAG_LEN</span>
                        <span class="op">+</span> <span class="ident">curve::curve25519::PUBLIC_KEY_LENGTH</span>
                {
                    <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>);
                }
                <span class="kw">let</span> (<span class="ident">encrypted_message_key</span>, <span class="ident">remaining</span>) <span class="op">=</span>
                    <span class="ident">remaining</span>.<span class="ident">split_at</span>(<span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span>);
                <span class="kw">let</span> (<span class="ident">encrypted_authentication_tag</span>, <span class="ident">remaining</span>) <span class="op">=</span>
                    <span class="ident">remaining</span>.<span class="ident">split_at</span>(<span class="ident">sealed_sender_v2::AUTH_TAG_LEN</span>);
                <span class="kw">let</span> (<span class="ident">ephemeral_public</span>, <span class="ident">encrypted_message</span>) <span class="op">=</span>
                    <span class="ident">remaining</span>.<span class="ident">split_at</span>(<span class="ident">curve::curve25519::PUBLIC_KEY_LENGTH</span>);

                <span class="prelude-val">Ok</span>(<span class="ident"><span class="self">Self</span>::V2</span> {
                    <span class="ident">ephemeral_public</span>: <span class="ident">PublicKey::from_djb_public_key_bytes</span>(<span class="ident">ephemeral_public</span>)<span class="question-mark">?</span>,
                    <span class="ident">encrypted_message_key</span>: <span class="ident">encrypted_message_key</span>.<span class="ident">into</span>(),
                    <span class="ident">authentication_tag</span>: <span class="ident">encrypted_authentication_tag</span>.<span class="ident">into</span>(),
                    <span class="ident">encrypted_message</span>: <span class="ident">encrypted_message</span>.<span class="ident">into</span>(),
                })
            }
            <span class="kw">_</span> =&gt; <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::UnknownSealedSenderVersion</span>(<span class="ident">version</span>)),
        }
    }
}

<span class="kw">mod</span> <span class="ident">sealed_sender_v1</span> {
    <span class="kw">use</span> <span class="kw">super</span>::<span class="kw-2">*</span>;

    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">test</span>)]</span>
    <span class="kw">use</span> <span class="ident">std::fmt</span>;

    <span class="doccomment">/// A symmetric cipher key and a MAC key, along with a &quot;chain key&quot; consumed in</span>
    <span class="doccomment">/// [`StaticKeys::calculate`].</span>
    <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">struct</span> <span class="ident">EphemeralKeys</span> {
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">chain_key</span>: [<span class="ident">u8</span>; <span class="number">32</span>],
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">cipher_key</span>: [<span class="ident">u8</span>; <span class="number">32</span>],
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">mac_key</span>: [<span class="ident">u8</span>; <span class="number">32</span>],
    }

    <span class="kw">const</span> <span class="ident">SALT_PREFIX</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>] <span class="op">=</span> <span class="string">b&quot;UnidentifiedDelivery&quot;</span>;
    <span class="kw">const</span> <span class="ident">EPHEMERAL_KEYS_KDF_LEN</span>: <span class="ident">usize</span> <span class="op">=</span> <span class="number">96</span>;

    <span class="kw">impl</span> <span class="ident">EphemeralKeys</span> {
        <span class="doccomment">/// Derive a set of symmetric keys from the key agreement between the sender and</span>
        <span class="doccomment">/// recipient&#39;s identities.</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">calculate</span>(
            <span class="ident">our_keys</span>: <span class="kw-2">&amp;</span><span class="ident">KeyPair</span>,
            <span class="ident">their_public</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>,
            <span class="ident">direction</span>: <span class="ident">Direction</span>,
        ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="ident">our_pub_key</span> <span class="op">=</span> <span class="ident">our_keys</span>.<span class="ident">public_key</span>.<span class="ident">serialize</span>();
            <span class="kw">let</span> <span class="ident">their_pub_key</span> <span class="op">=</span> <span class="ident">their_public</span>.<span class="ident">serialize</span>();
            <span class="kw">let</span> <span class="ident">ephemeral_salt</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">direction</span> {
                <span class="ident">Direction::Sending</span> =&gt; [<span class="ident">SALT_PREFIX</span>, <span class="kw-2">&amp;</span><span class="ident">their_pub_key</span>, <span class="kw-2">&amp;</span><span class="ident">our_pub_key</span>],
                <span class="ident">Direction::Receiving</span> =&gt; [<span class="ident">SALT_PREFIX</span>, <span class="kw-2">&amp;</span><span class="ident">our_pub_key</span>, <span class="kw-2">&amp;</span><span class="ident">their_pub_key</span>],
            }
            .<span class="ident">concat</span>();

            <span class="kw">let</span> <span class="ident">shared_secret</span> <span class="op">=</span> <span class="ident">our_keys</span>.<span class="ident">private_key</span>.<span class="ident">calculate_agreement</span>(<span class="ident">their_public</span>)<span class="question-mark">?</span>;
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">derived_values</span> <span class="op">=</span> [<span class="number">0</span>; <span class="ident">EPHEMERAL_KEYS_KDF_LEN</span>];
            <span class="ident">hkdf::Hkdf</span>::<span class="op">&lt;</span><span class="ident">sha2::Sha256</span><span class="op">&gt;</span><span class="ident">::new</span>(<span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span><span class="ident">ephemeral_salt</span>), <span class="kw-2">&amp;</span><span class="ident">shared_secret</span>)
                .<span class="ident">expand</span>(<span class="kw-2">&amp;</span>[], <span class="kw-2">&amp;mut</span> <span class="ident">derived_values</span>)
                .<span class="ident">expect</span>(<span class="string">&quot;valid output length&quot;</span>);

            <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
                <span class="ident">chain_key</span>: <span class="kw-2">*</span><span class="macro">array_ref!</span>[<span class="kw-2">&amp;</span><span class="ident">derived_values</span>, <span class="number">0</span>, <span class="number">32</span>],
                <span class="ident">cipher_key</span>: <span class="kw-2">*</span><span class="macro">array_ref!</span>[<span class="kw-2">&amp;</span><span class="ident">derived_values</span>, <span class="number">32</span>, <span class="number">32</span>],
                <span class="ident">mac_key</span>: <span class="kw-2">*</span><span class="macro">array_ref!</span>[<span class="kw-2">&amp;</span><span class="ident">derived_values</span>, <span class="number">64</span>, <span class="number">32</span>],
            })
        }
    }

    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">test</span>)]</span>
    <span class="kw">impl</span> <span class="ident">PartialEq</span> <span class="kw">for</span> <span class="ident">EphemeralKeys</span> {
        <span class="kw">fn</span> <span class="ident">eq</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">other</span>: <span class="kw-2">&amp;</span><span class="self">Self</span>) -&gt; <span class="ident">bool</span> {
            <span class="self">self</span>.<span class="ident">chain_key</span> <span class="op">==</span> <span class="ident">other</span>.<span class="ident">chain_key</span>
                <span class="op">&amp;&amp;</span> <span class="self">self</span>.<span class="ident">cipher_key</span> <span class="op">==</span> <span class="ident">other</span>.<span class="ident">cipher_key</span>
                <span class="op">&amp;&amp;</span> <span class="self">self</span>.<span class="ident">mac_key</span> <span class="op">==</span> <span class="ident">other</span>.<span class="ident">mac_key</span>
        }
    }

    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">test</span>)]</span>
    <span class="kw">impl</span> <span class="ident">Eq</span> <span class="kw">for</span> <span class="ident">EphemeralKeys</span> {}

    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">test</span>)]</span>
    <span class="kw">impl</span> <span class="ident">fmt::Debug</span> <span class="kw">for</span> <span class="ident">EphemeralKeys</span> {
        <span class="kw">fn</span> <span class="ident">fmt</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">f</span>: <span class="kw-2">&amp;mut</span> <span class="ident">fmt::Formatter</span>) -&gt; <span class="ident">fmt::Result</span> {
            <span class="macro">write!</span>(
                <span class="ident">f</span>,
                <span class="string">&quot;EphemeralKeys {{ chain_key: {:?}, cipher_key: {:?}, mac_key: {:?} }}&quot;</span>,
                <span class="self">self</span>.<span class="ident">chain_key</span>, <span class="self">self</span>.<span class="ident">cipher_key</span>, <span class="self">self</span>.<span class="ident">mac_key</span>
            )
        }
    }

    <span class="doccomment">/// A symmetric cipher key and a MAC key.</span>
    <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">struct</span> <span class="ident">StaticKeys</span> {
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">cipher_key</span>: [<span class="ident">u8</span>; <span class="number">32</span>],
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">mac_key</span>: [<span class="ident">u8</span>; <span class="number">32</span>],
    }

    <span class="kw">impl</span> <span class="ident">StaticKeys</span> {
        <span class="doccomment">/// Derive a set of symmetric keys from the agreement between the sender and</span>
        <span class="doccomment">/// recipient&#39;s identities, as well as [`EphemeralKeys::chain_key`].</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">calculate</span>(
            <span class="ident">our_keys</span>: <span class="kw-2">&amp;</span><span class="ident">IdentityKeyPair</span>,
            <span class="ident">their_key</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>,
            <span class="ident">chain_key</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>; <span class="number">32</span>],
            <span class="ident">ctext</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>],
        ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
            <span class="kw">let</span> <span class="ident">salt</span> <span class="op">=</span> [<span class="ident">chain_key</span>, <span class="ident">ctext</span>].<span class="ident">concat</span>();

            <span class="kw">let</span> <span class="ident">shared_secret</span> <span class="op">=</span> <span class="ident">our_keys</span>.<span class="ident">private_key</span>().<span class="ident">calculate_agreement</span>(<span class="ident">their_key</span>)<span class="question-mark">?</span>;
            <span class="comment">// 96 bytes are derived, but the first 32 are discarded/unused. This is intended to</span>
            <span class="comment">// mirror the way the EphemeralKeys are derived, even though StaticKeys does not end up</span>
            <span class="comment">// requiring a third &quot;chain key&quot;.</span>
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">derived_values</span> <span class="op">=</span> [<span class="number">0</span>; <span class="number">96</span>];
            <span class="ident">hkdf::Hkdf</span>::<span class="op">&lt;</span><span class="ident">sha2::Sha256</span><span class="op">&gt;</span><span class="ident">::new</span>(<span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span><span class="ident">salt</span>), <span class="kw-2">&amp;</span><span class="ident">shared_secret</span>)
                .<span class="ident">expand</span>(<span class="kw-2">&amp;</span>[], <span class="kw-2">&amp;mut</span> <span class="ident">derived_values</span>)
                .<span class="ident">expect</span>(<span class="string">&quot;valid output length&quot;</span>);

            <span class="prelude-val">Ok</span>(<span class="self">Self</span> {
                <span class="ident">cipher_key</span>: <span class="kw-2">*</span><span class="macro">array_ref!</span>[<span class="kw-2">&amp;</span><span class="ident">derived_values</span>, <span class="number">32</span>, <span class="number">32</span>],
                <span class="ident">mac_key</span>: <span class="kw-2">*</span><span class="macro">array_ref!</span>[<span class="kw-2">&amp;</span><span class="ident">derived_values</span>, <span class="number">64</span>, <span class="number">32</span>],
            })
        }
    }

    <span class="attribute">#[<span class="ident">test</span>]</span>
    <span class="kw">fn</span> <span class="ident">test_agreement_and_authentication</span>() -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="comment">// The sender and recipient each have a long-term identity key pair.</span>
        <span class="kw">let</span> <span class="ident">sender_identity</span> <span class="op">=</span> <span class="ident">IdentityKeyPair::generate</span>(<span class="kw-2">&amp;mut</span> <span class="ident">rand::thread_rng</span>());
        <span class="kw">let</span> <span class="ident">recipient_identity</span> <span class="op">=</span> <span class="ident">IdentityKeyPair::generate</span>(<span class="kw-2">&amp;mut</span> <span class="ident">rand::thread_rng</span>());

        <span class="comment">// Generate an ephemeral key pair.</span>
        <span class="kw">let</span> <span class="ident">sender_ephemeral</span> <span class="op">=</span> <span class="ident">KeyPair::generate</span>(<span class="kw-2">&amp;mut</span> <span class="ident">rand::thread_rng</span>());
        <span class="kw">let</span> <span class="ident">ephemeral_public</span> <span class="op">=</span> <span class="ident">sender_ephemeral</span>.<span class="ident">public_key</span>;
        <span class="comment">// Generate ephemeral cipher, chain, and MAC keys.</span>
        <span class="kw">let</span> <span class="ident">sender_eph_keys</span> <span class="op">=</span> <span class="ident">EphemeralKeys::calculate</span>(
            <span class="kw-2">&amp;</span><span class="ident">sender_ephemeral</span>,
            <span class="ident">recipient_identity</span>.<span class="ident">public_key</span>(),
            <span class="ident">Direction::Sending</span>,
        )<span class="question-mark">?</span>;

        <span class="comment">// Encrypt the sender&#39;s public key with AES-256 CTR and a MAC.</span>
        <span class="kw">let</span> <span class="ident">sender_static_key_ctext</span> <span class="op">=</span> <span class="ident">crypto::aes256_ctr_hmacsha256_encrypt</span>(
            <span class="kw-2">&amp;</span><span class="ident">sender_identity</span>.<span class="ident">public_key</span>().<span class="ident">serialize</span>(),
            <span class="kw-2">&amp;</span><span class="ident">sender_eph_keys</span>.<span class="ident">cipher_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_eph_keys</span>.<span class="ident">mac_key</span>,
        )
        .<span class="ident">expect</span>(<span class="string">&quot;just generated these keys, they should be correct&quot;</span>);

        <span class="comment">// Generate another cipher and MAC key.</span>
        <span class="kw">let</span> <span class="ident">sender_static_keys</span> <span class="op">=</span> <span class="ident">StaticKeys::calculate</span>(
            <span class="kw-2">&amp;</span><span class="ident">sender_identity</span>,
            <span class="ident">recipient_identity</span>.<span class="ident">public_key</span>(),
            <span class="kw-2">&amp;</span><span class="ident">sender_eph_keys</span>.<span class="ident">chain_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_static_key_ctext</span>,
        )<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">sender_message_contents</span> <span class="op">=</span> <span class="string">b&quot;this is a binary message&quot;</span>;
        <span class="kw">let</span> <span class="ident">sender_message_data</span> <span class="op">=</span> <span class="ident">crypto::aes256_ctr_hmacsha256_encrypt</span>(
            <span class="ident">sender_message_contents</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_static_keys</span>.<span class="ident">cipher_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_static_keys</span>.<span class="ident">mac_key</span>,
        )
        .<span class="ident">expect</span>(<span class="string">&quot;just generated these keys, they should be correct&quot;</span>);

        <span class="comment">// The message recipient calculates the ephemeral key and the sender&#39;s public key.</span>
        <span class="kw">let</span> <span class="ident">recipient_eph_keys</span> <span class="op">=</span> <span class="ident">EphemeralKeys::calculate</span>(
            <span class="kw-2">&amp;</span><span class="ident">recipient_identity</span>.<span class="ident">into</span>(),
            <span class="kw-2">&amp;</span><span class="ident">ephemeral_public</span>,
            <span class="ident">Direction::Receiving</span>,
        )<span class="question-mark">?</span>;
        <span class="macro">assert_eq!</span>(<span class="ident">sender_eph_keys</span>, <span class="ident">recipient_eph_keys</span>);

        <span class="kw">let</span> <span class="ident">recipient_message_key_bytes</span> <span class="op">=</span> <span class="ident">crypto::aes256_ctr_hmacsha256_decrypt</span>(
            <span class="kw-2">&amp;</span><span class="ident">sender_static_key_ctext</span>,
            <span class="kw-2">&amp;</span><span class="ident">recipient_eph_keys</span>.<span class="ident">cipher_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">recipient_eph_keys</span>.<span class="ident">mac_key</span>,
        )
        .<span class="ident">expect</span>(<span class="string">&quot;should decrypt successfully&quot;</span>);
        <span class="kw">let</span> <span class="ident">sender_public_key</span>: <span class="ident">PublicKey</span> <span class="op">=</span> <span class="ident">PublicKey::try_from</span>(<span class="kw-2">&amp;</span><span class="ident">recipient_message_key_bytes</span>[..])<span class="question-mark">?</span>;
        <span class="macro">assert_eq!</span>(<span class="ident">sender_identity</span>.<span class="ident">public_key</span>(), <span class="kw-2">&amp;</span><span class="ident">sender_public_key</span>);

        <span class="kw">let</span> <span class="ident">recipient_static_keys</span> <span class="op">=</span> <span class="ident">StaticKeys::calculate</span>(
            <span class="kw-2">&amp;</span><span class="ident">recipient_identity</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_public_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">recipient_eph_keys</span>.<span class="ident">chain_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_static_key_ctext</span>,
        )<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">recipient_message_contents</span> <span class="op">=</span> <span class="ident">crypto::aes256_ctr_hmacsha256_decrypt</span>(
            <span class="kw-2">&amp;</span><span class="ident">sender_message_data</span>,
            <span class="kw-2">&amp;</span><span class="ident">recipient_static_keys</span>.<span class="ident">cipher_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">recipient_static_keys</span>.<span class="ident">mac_key</span>,
        )
        .<span class="ident">expect</span>(<span class="string">&quot;should decrypt successfully&quot;</span>);
        <span class="macro">assert_eq!</span>(<span class="ident">recipient_message_contents</span>, <span class="ident">sender_message_contents</span>);

        <span class="prelude-val">Ok</span>(())
    }
}

<span class="doccomment">/// Encrypt the plaintext message `ptext`, generate an [`UnidentifiedSenderMessageContent`], then</span>
<span class="doccomment">/// pass the result to [`sealed_sender_encrypt_from_usmc`].</span>
<span class="doccomment">///</span>
<span class="doccomment">/// This is a simple way to encrypt a message in a 1:1 using [Sealed Sender v1].</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [Sealed Sender v1]: sealed_sender_encrypt_from_usmc</span>
<span class="kw">pub</span> <span class="kw">async</span> <span class="kw">fn</span> <span class="ident">sealed_sender_encrypt</span><span class="op">&lt;</span><span class="ident">R</span>: <span class="ident">Rng</span> <span class="op">+</span> <span class="ident">CryptoRng</span><span class="op">&gt;</span>(
    <span class="ident">destination</span>: <span class="kw-2">&amp;</span><span class="ident">ProtocolAddress</span>,
    <span class="ident">sender_cert</span>: <span class="kw-2">&amp;</span><span class="ident">SenderCertificate</span>,
    <span class="ident">ptext</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>],
    <span class="ident">session_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">SessionStore</span>,
    <span class="ident">identity_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">IdentityKeyStore</span>,
    <span class="ident">ctx</span>: <span class="ident">Context</span>,
    <span class="ident">rng</span>: <span class="kw-2">&amp;mut</span> <span class="ident">R</span>,
) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">message</span> <span class="op">=</span> <span class="ident">message_encrypt</span>(<span class="ident">ptext</span>, <span class="ident">destination</span>, <span class="ident">session_store</span>, <span class="ident">identity_store</span>, <span class="ident">ctx</span>).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let</span> <span class="ident">usmc</span> <span class="op">=</span> <span class="ident">UnidentifiedSenderMessageContent::new</span>(
        <span class="ident">message</span>.<span class="ident">message_type</span>(),
        <span class="ident">sender_cert</span>.<span class="ident">clone</span>(),
        <span class="ident">message</span>.<span class="ident">serialize</span>().<span class="ident">to_vec</span>(),
        <span class="ident">ContentHint::Default</span>,
        <span class="prelude-val">None</span>,
    )<span class="question-mark">?</span>;
    <span class="ident">sealed_sender_encrypt_from_usmc</span>(<span class="ident">destination</span>, <span class="kw-2">&amp;</span><span class="ident">usmc</span>, <span class="ident">identity_store</span>, <span class="ident">ctx</span>, <span class="ident">rng</span>).<span class="kw">await</span>
}

<span class="doccomment">/// This method implements the single-key single-recipient [KEM] described in [this Signal blog</span>
<span class="doccomment">/// post], a.k.a. Sealed Sender v1.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [KEM]: https://en.wikipedia.org/wiki/Key_encapsulation</span>
<span class="doccomment">/// [this Signal blog post]: https://signal.org/blog/sealed-sender/</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`sealed_sender_decrypt`] is used in the client to decrypt the Sealed Sender message produced by</span>
<span class="doccomment">/// this method.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # Contrast with Sealed Sender v2</span>
<span class="doccomment">/// The *single-recipient* KEM scheme implemented by this method partially derives the encryption</span>
<span class="doccomment">/// key from the recipient&#39;s identity key, which would then require re-encrypting the same message</span>
<span class="doccomment">/// multiple times to send to multiple recipients. In contrast,</span>
<span class="doccomment">/// [Sealed Sender v2](sealed_sender_multi_recipient_encrypt) uses a *multi-recipient* KEM scheme</span>
<span class="doccomment">/// which avoids this repeated work, but makes a few additional design tradeoffs.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # High-level algorithmic overview</span>
<span class="doccomment">/// The KEM scheme implemented by this method is described in [this Signal blog post]. The</span>
<span class="doccomment">/// high-level steps of this process are listed below:</span>
<span class="doccomment">/// 1. Generate a random key pair.</span>
<span class="doccomment">/// 2. Derive a symmetric chain key, cipher key, and MAC key from the recipient&#39;s public key and the</span>
<span class="doccomment">///    sender&#39;s public/private key pair.</span>
<span class="doccomment">/// 3. Symmetrically encrypt the sender&#39;s public key using the cipher key and MAC key from (2) with</span>
<span class="doccomment">///    AES-256 in CTR mode.</span>
<span class="doccomment">/// 4. Derive a second symmetric cipher key and MAC key from the sender&#39;s private key, the</span>
<span class="doccomment">///    recipient&#39;s public key, and the chain key from (2).</span>
<span class="doccomment">/// 5. Symmetrically encrypt the underlying [`UnidentifiedSenderMessageContent`] using the cipher key</span>
<span class="doccomment">///    and MAC key from (4) with AES-256 in CTR mode.</span>
<span class="doccomment">/// 6. Send the ephemeral public key from (1) and the encrypted public key from (3) to the</span>
<span class="doccomment">///    recipient, along with the encrypted message (5).</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ## Pseudocode</span>
<span class="doccomment">///```text</span>
<span class="doccomment">/// e_pub, e_priv                  = X25519.generateEphemeral()</span>
<span class="doccomment">/// e_chain, e_cipherKey, e_macKey = HKDF(salt=&quot;UnidentifiedDelivery&quot; || recipientIdentityPublic || e_pub, ikm=ECDH(recipientIdentityPublic, e_priv), info=&quot;&quot;)</span>
<span class="doccomment">/// e_ciphertext                   = AES_CTR(key=e_cipherKey, input=senderIdentityPublic)</span>
<span class="doccomment">/// e_mac                          = Hmac256(key=e_macKey, input=e_ciphertext)</span>
<span class="doccomment">///</span>
<span class="doccomment">/// s_cipherKey, s_macKey = HKDF(salt=e_chain || e_ciphertext || e_mac, ikm=ECDH(recipientIdentityPublic, senderIdentityPrivate), info=&quot;&quot;)</span>
<span class="doccomment">/// s_ciphertext          = AES_CTR(key=s_cipherKey, input=sender_certificate || message_ciphertext)</span>
<span class="doccomment">/// s_mac                 = Hmac256(key=s_macKey, input=s_ciphertext)</span>
<span class="doccomment">///</span>
<span class="doccomment">/// message_to_send = s_ciphertext || s_mac</span>
<span class="doccomment">///```</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # Wire Format</span>
<span class="doccomment">/// The output of this method is encoded as an `UnidentifiedSenderMessage.Message` from</span>
<span class="doccomment">/// `sealed_sender.proto`, prepended with an additional byte to indicate the version of Sealed</span>
<span class="doccomment">/// Sender in use (see [further documentation on the version</span>
<span class="doccomment">/// byte](sealed_sender_multi_recipient_encrypt#the-version-byte)).</span>
<span class="kw">pub</span> <span class="kw">async</span> <span class="kw">fn</span> <span class="ident">sealed_sender_encrypt_from_usmc</span><span class="op">&lt;</span><span class="ident">R</span>: <span class="ident">Rng</span> <span class="op">+</span> <span class="ident">CryptoRng</span><span class="op">&gt;</span>(
    <span class="ident">destination</span>: <span class="kw-2">&amp;</span><span class="ident">ProtocolAddress</span>,
    <span class="ident">usmc</span>: <span class="kw-2">&amp;</span><span class="ident">UnidentifiedSenderMessageContent</span>,
    <span class="ident">identity_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">IdentityKeyStore</span>,
    <span class="ident">ctx</span>: <span class="ident">Context</span>,
    <span class="ident">rng</span>: <span class="kw-2">&amp;mut</span> <span class="ident">R</span>,
) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">our_identity</span> <span class="op">=</span> <span class="ident">identity_store</span>.<span class="ident">get_identity_key_pair</span>(<span class="ident">ctx</span>).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let</span> <span class="ident">their_identity</span> <span class="op">=</span> <span class="ident">identity_store</span>
        .<span class="ident">get_identity</span>(<span class="ident">destination</span>, <span class="ident">ctx</span>)
        .<span class="kw">await</span><span class="question-mark">?</span>
        .<span class="ident">ok_or_else</span>(<span class="op">|</span><span class="op">|</span> <span class="ident">SignalProtocolError::SessionNotFound</span>(<span class="ident">destination</span>.<span class="ident">clone</span>()))<span class="question-mark">?</span>;

    <span class="kw">let</span> <span class="ident">ephemeral</span> <span class="op">=</span> <span class="ident">KeyPair::generate</span>(<span class="ident">rng</span>);

    <span class="kw">let</span> <span class="ident">eph_keys</span> <span class="op">=</span> <span class="ident">sealed_sender_v1::EphemeralKeys::calculate</span>(
        <span class="kw-2">&amp;</span><span class="ident">ephemeral</span>,
        <span class="ident">their_identity</span>.<span class="ident">public_key</span>(),
        <span class="ident">Direction::Sending</span>,
    )<span class="question-mark">?</span>;

    <span class="kw">let</span> <span class="ident">static_key_ctext</span> <span class="op">=</span> <span class="ident">crypto::aes256_ctr_hmacsha256_encrypt</span>(
        <span class="kw-2">&amp;</span><span class="ident">our_identity</span>.<span class="ident">public_key</span>().<span class="ident">serialize</span>(),
        <span class="kw-2">&amp;</span><span class="ident">eph_keys</span>.<span class="ident">cipher_key</span>,
        <span class="kw-2">&amp;</span><span class="ident">eph_keys</span>.<span class="ident">mac_key</span>,
    )
    .<span class="ident">expect</span>(<span class="string">&quot;just generated these keys, they should be correct&quot;</span>);

    <span class="kw">let</span> <span class="ident">static_keys</span> <span class="op">=</span> <span class="ident">sealed_sender_v1::StaticKeys::calculate</span>(
        <span class="kw-2">&amp;</span><span class="ident">our_identity</span>,
        <span class="ident">their_identity</span>.<span class="ident">public_key</span>(),
        <span class="kw-2">&amp;</span><span class="ident">eph_keys</span>.<span class="ident">chain_key</span>,
        <span class="kw-2">&amp;</span><span class="ident">static_key_ctext</span>,
    )<span class="question-mark">?</span>;

    <span class="kw">let</span> <span class="ident">message_data</span> <span class="op">=</span> <span class="ident">crypto::aes256_ctr_hmacsha256_encrypt</span>(
        <span class="ident">usmc</span>.<span class="ident">serialized</span>()<span class="question-mark">?</span>,
        <span class="kw-2">&amp;</span><span class="ident">static_keys</span>.<span class="ident">cipher_key</span>,
        <span class="kw-2">&amp;</span><span class="ident">static_keys</span>.<span class="ident">mac_key</span>,
    )
    .<span class="ident">expect</span>(<span class="string">&quot;just generated these keys, they should be correct&quot;</span>);

    <span class="kw">let</span> <span class="ident">version</span> <span class="op">=</span> <span class="ident">SEALED_SENDER_V1_VERSION</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">serialized</span> <span class="op">=</span> <span class="macro">vec!</span>[<span class="ident">version</span> <span class="op">|</span> (<span class="ident">version</span> <span class="op">&lt;</span><span class="op">&lt;</span> <span class="number">4</span>)];
    <span class="kw">let</span> <span class="ident">pb</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::UnidentifiedSenderMessage</span> {
        <span class="ident">ephemeral_public</span>: <span class="prelude-val">Some</span>(<span class="ident">ephemeral</span>.<span class="ident">public_key</span>.<span class="ident">serialize</span>().<span class="ident">to_vec</span>()),
        <span class="ident">encrypted_static</span>: <span class="prelude-val">Some</span>(<span class="ident">static_key_ctext</span>),
        <span class="ident">encrypted_message</span>: <span class="prelude-val">Some</span>(<span class="ident">message_data</span>),
    };
    <span class="ident">pb</span>.<span class="ident">encode</span>(<span class="kw-2">&amp;mut</span> <span class="ident">serialized</span>)
        .<span class="ident">expect</span>(<span class="string">&quot;can always append to Vec&quot;</span>);

    <span class="prelude-val">Ok</span>(<span class="ident">serialized</span>)
}

<span class="kw">mod</span> <span class="ident">sealed_sender_v2</span> {
    <span class="kw">use</span> <span class="kw">super</span>::<span class="kw-2">*</span>;

    <span class="comment">// Static byte strings used as part of a MAC in HKDF.</span>
    <span class="kw">const</span> <span class="ident">LABEL_R</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>] <span class="op">=</span> <span class="string">b&quot;Sealed Sender v2: r&quot;</span>;
    <span class="kw">const</span> <span class="ident">LABEL_K</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>] <span class="op">=</span> <span class="string">b&quot;Sealed Sender v2: K&quot;</span>;
    <span class="kw">const</span> <span class="ident">LABEL_DH</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>] <span class="op">=</span> <span class="string">b&quot;Sealed Sender v2: DH&quot;</span>;
    <span class="kw">const</span> <span class="ident">LABEL_DH_S</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>] <span class="op">=</span> <span class="string">b&quot;Sealed Sender v2: DH-sender&quot;</span>;

    <span class="kw">pub</span> <span class="kw">const</span> <span class="ident">MESSAGE_KEY_LEN</span>: <span class="ident">usize</span> <span class="op">=</span> <span class="number">32</span>;
    <span class="kw">pub</span> <span class="kw">const</span> <span class="ident">AUTH_TAG_LEN</span>: <span class="ident">usize</span> <span class="op">=</span> <span class="number">16</span>;

    <span class="doccomment">/// An asymmetric and a symmetric cipher key.</span>
    <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">struct</span> <span class="ident">DerivedKeys</span> {
        <span class="doccomment">/// Asymmetric key pair.</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">e</span>: <span class="ident">KeyPair</span>,
        <span class="doccomment">/// Symmetric key used to instantiate [`Aes256GcmSiv::new_from_slice`].</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="ident">k</span>: [<span class="ident">u8</span>; <span class="ident">MESSAGE_KEY_LEN</span>],
    }

    <span class="kw">impl</span> <span class="ident">DerivedKeys</span> {
        <span class="doccomment">/// Derive a set of ephemeral keys from a slice of random bytes `m`.</span>
        <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">calculate</span>(<span class="ident">m</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="ident">DerivedKeys</span> {
            <span class="kw">let</span> <span class="ident">kdf</span> <span class="op">=</span> <span class="ident">hkdf::Hkdf</span>::<span class="op">&lt;</span><span class="ident">sha2::Sha256</span><span class="op">&gt;</span><span class="ident">::new</span>(<span class="prelude-val">None</span>, <span class="ident">m</span>);
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">r</span> <span class="op">=</span> [<span class="number">0</span>; <span class="number">64</span>];
            <span class="ident">kdf</span>.<span class="ident">expand</span>(<span class="ident">LABEL_R</span>, <span class="kw-2">&amp;mut</span> <span class="ident">r</span>).<span class="ident">expect</span>(<span class="string">&quot;valid output length&quot;</span>);
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">k</span> <span class="op">=</span> [<span class="number">0</span>; <span class="ident">MESSAGE_KEY_LEN</span>];
            <span class="ident">kdf</span>.<span class="ident">expand</span>(<span class="ident">LABEL_K</span>, <span class="kw-2">&amp;mut</span> <span class="ident">k</span>).<span class="ident">expect</span>(<span class="string">&quot;valid output length&quot;</span>);
            <span class="kw">let</span> <span class="ident">e_raw</span> <span class="op">=</span> <span class="ident">Scalar::from_bytes_mod_order_wide</span>(<span class="kw-2">&amp;</span><span class="ident">r</span>);
            <span class="kw">let</span> <span class="ident">e</span> <span class="op">=</span> <span class="ident">PrivateKey::try_from</span>(<span class="kw-2">&amp;</span><span class="ident">e_raw</span>.<span class="ident">as_bytes</span>()[..]).<span class="ident">expect</span>(<span class="string">&quot;valid PrivateKey&quot;</span>);
            <span class="kw">let</span> <span class="ident">e</span> <span class="op">=</span> <span class="ident">KeyPair::try_from</span>(<span class="ident">e</span>).<span class="ident">expect</span>(<span class="string">&quot;can derive public key&quot;</span>);
            <span class="ident">DerivedKeys</span> { <span class="ident">e</span>, <span class="ident">k</span> }
        }
    }

    <span class="doccomment">/// Encrypt or decrypt a slice of random bytes `input` using a shared secret derived from</span>
    <span class="doccomment">/// `our_keys` and `their_key`.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// The output of this method when called with [`Direction::Sending`] can be inverted to produce</span>
    <span class="doccomment">/// the original `input` bytes if called with [`Direction::Receiving`] with `our_keys` and</span>
    <span class="doccomment">/// `their_key` swapped.</span>
    <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">apply_agreement_xor</span>(
        <span class="ident">our_keys</span>: <span class="kw-2">&amp;</span><span class="ident">KeyPair</span>,
        <span class="ident">their_key</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>,
        <span class="ident">direction</span>: <span class="ident">Direction</span>,
        <span class="ident">input</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>; <span class="ident">MESSAGE_KEY_LEN</span>],
    ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>[<span class="ident">u8</span>; <span class="ident">MESSAGE_KEY_LEN</span>]<span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">agreement</span> <span class="op">=</span> <span class="ident">our_keys</span>.<span class="ident">calculate_agreement</span>(<span class="ident">their_key</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">agreement_key_input</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">direction</span> {
            <span class="ident">Direction::Sending</span> =&gt; [
                <span class="ident">agreement</span>,
                <span class="ident">our_keys</span>.<span class="ident">public_key</span>.<span class="ident">serialize</span>(),
                <span class="ident">their_key</span>.<span class="ident">serialize</span>(),
            ],
            <span class="ident">Direction::Receiving</span> =&gt; [
                <span class="ident">agreement</span>,
                <span class="ident">their_key</span>.<span class="ident">serialize</span>(),
                <span class="ident">our_keys</span>.<span class="ident">public_key</span>.<span class="ident">serialize</span>(),
            ],
        }
        .<span class="ident">concat</span>();

        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">result</span> <span class="op">=</span> [<span class="number">0</span>; <span class="ident">MESSAGE_KEY_LEN</span>];
        <span class="ident">hkdf::Hkdf</span>::<span class="op">&lt;</span><span class="ident">sha2::Sha256</span><span class="op">&gt;</span><span class="ident">::new</span>(<span class="prelude-val">None</span>, <span class="kw-2">&amp;</span><span class="ident">agreement_key_input</span>)
            .<span class="ident">expand</span>(<span class="ident">LABEL_DH</span>, <span class="kw-2">&amp;mut</span> <span class="ident">result</span>)
            .<span class="ident">expect</span>(<span class="string">&quot;valid output length&quot;</span>);
        <span class="ident">result</span>
            .<span class="ident">iter_mut</span>()
            .<span class="ident">zip</span>(<span class="ident">input</span>)
            .<span class="ident">for_each</span>(<span class="op">|</span>(<span class="ident">result_byte</span>, <span class="ident">input_byte</span>)<span class="op">|</span> <span class="kw-2">*</span><span class="ident">result_byte</span> <span class="op">^</span><span class="op">=</span> <span class="ident">input_byte</span>);
        <span class="prelude-val">Ok</span>(<span class="ident">result</span>)
    }

    <span class="doccomment">/// Compute an [authentication tag] for the bytes `encrypted_message_key` using a shared secret</span>
    <span class="doccomment">/// derived from `our_keys` and `their_key`.</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// [authentication tag]: https://en.wikipedia.org/wiki/Message_authentication_code</span>
    <span class="doccomment">///</span>
    <span class="doccomment">/// The output of this method with [`Direction::Sending`] should be the same bytes produced by</span>
    <span class="doccomment">/// calling this method with [`Direction::Receiving`] with `our_keys` and `their_key`</span>
    <span class="doccomment">/// swapped, if `ephemeral_pub_key` and `encrypted_message_key` are the same.</span>
    <span class="kw">pub</span>(<span class="kw">super</span>) <span class="kw">fn</span> <span class="ident">compute_authentication_tag</span>(
        <span class="ident">our_keys</span>: <span class="kw-2">&amp;</span><span class="ident">IdentityKeyPair</span>,
        <span class="ident">their_key</span>: <span class="kw-2">&amp;</span><span class="ident">IdentityKey</span>,
        <span class="ident">direction</span>: <span class="ident">Direction</span>,
        <span class="ident">ephemeral_pub_key</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>,
        <span class="ident">encrypted_message_key</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>; <span class="ident">MESSAGE_KEY_LEN</span>],
    ) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>[<span class="ident">u8</span>; <span class="ident">AUTH_TAG_LEN</span>]<span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">agreement</span> <span class="op">=</span> <span class="ident">our_keys</span>
            .<span class="ident">private_key</span>()
            .<span class="ident">calculate_agreement</span>(<span class="ident">their_key</span>.<span class="ident">public_key</span>())<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">agreement_key_input</span> <span class="op">=</span> <span class="ident">agreement</span>.<span class="ident">into_vec</span>();
        <span class="ident">agreement_key_input</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">ephemeral_pub_key</span>.<span class="ident">serialize</span>());
        <span class="ident">agreement_key_input</span>.<span class="ident">extend_from_slice</span>(<span class="ident">encrypted_message_key</span>);
        <span class="kw">match</span> <span class="ident">direction</span> {
            <span class="ident">Direction::Sending</span> =&gt; {
                <span class="ident">agreement_key_input</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">our_keys</span>.<span class="ident">public_key</span>().<span class="ident">serialize</span>());
                <span class="ident">agreement_key_input</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">their_key</span>.<span class="ident">serialize</span>());
            }
            <span class="ident">Direction::Receiving</span> =&gt; {
                <span class="ident">agreement_key_input</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">their_key</span>.<span class="ident">serialize</span>());
                <span class="ident">agreement_key_input</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">our_keys</span>.<span class="ident">public_key</span>().<span class="ident">serialize</span>());
            }
        }

        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">result</span> <span class="op">=</span> [<span class="number">0</span>; <span class="ident">AUTH_TAG_LEN</span>];
        <span class="ident">hkdf::Hkdf</span>::<span class="op">&lt;</span><span class="ident">sha2::Sha256</span><span class="op">&gt;</span><span class="ident">::new</span>(<span class="prelude-val">None</span>, <span class="kw-2">&amp;</span><span class="ident">agreement_key_input</span>)
            .<span class="ident">expand</span>(<span class="ident">LABEL_DH_S</span>, <span class="kw-2">&amp;mut</span> <span class="ident">result</span>)
            .<span class="ident">expect</span>(<span class="string">&quot;valid output length&quot;</span>);
        <span class="prelude-val">Ok</span>(<span class="ident">result</span>)
    }

    <span class="attribute">#[<span class="ident">test</span>]</span>
    <span class="kw">fn</span> <span class="ident">test_agreement_and_authentication</span>() -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="comment">// The sender and recipient each have a long-term identity key pair.</span>
        <span class="kw">let</span> <span class="ident">sender_identity</span> <span class="op">=</span> <span class="ident">IdentityKeyPair::generate</span>(<span class="kw-2">&amp;mut</span> <span class="ident">rand::thread_rng</span>());
        <span class="kw">let</span> <span class="ident">recipient_identity</span> <span class="op">=</span> <span class="ident">IdentityKeyPair::generate</span>(<span class="kw-2">&amp;mut</span> <span class="ident">rand::thread_rng</span>());

        <span class="comment">// Generate random bytes used for our multi-recipient encoding scheme.</span>
        <span class="kw">let</span> <span class="ident">m</span>: [<span class="ident">u8</span>; <span class="ident">MESSAGE_KEY_LEN</span>] <span class="op">=</span> <span class="ident">rand::thread_rng</span>().<span class="ident">gen</span>();
        <span class="comment">// Derive an ephemeral key pair from those random bytes.</span>
        <span class="kw">let</span> <span class="ident">ephemeral_keys</span> <span class="op">=</span> <span class="ident">DerivedKeys::calculate</span>(<span class="kw-2">&amp;</span><span class="ident">m</span>);
        <span class="kw">let</span> <span class="ident">ephemeral_public_key</span> <span class="op">=</span> <span class="ident">ephemeral_keys</span>.<span class="ident">e</span>.<span class="ident">public_key</span>;

        <span class="comment">// Encrypt the ephemeral key pair.</span>
        <span class="kw">let</span> <span class="ident">sender_c_0</span>: [<span class="ident">u8</span>; <span class="ident">MESSAGE_KEY_LEN</span>] <span class="op">=</span> <span class="ident">apply_agreement_xor</span>(
            <span class="kw-2">&amp;</span><span class="ident">ephemeral_keys</span>.<span class="ident">e</span>,
            <span class="ident">recipient_identity</span>.<span class="ident">public_key</span>(),
            <span class="ident">Direction::Sending</span>,
            <span class="kw-2">&amp;</span><span class="ident">m</span>,
        )<span class="question-mark">?</span>;
        <span class="comment">// Compute an authentication tag for the encrypted key pair.</span>
        <span class="kw">let</span> <span class="ident">sender_at_0</span> <span class="op">=</span> <span class="ident">compute_authentication_tag</span>(
            <span class="kw-2">&amp;</span><span class="ident">sender_identity</span>,
            <span class="ident">recipient_identity</span>.<span class="ident">identity_key</span>(),
            <span class="ident">Direction::Sending</span>,
            <span class="kw-2">&amp;</span><span class="ident">ephemeral_public_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_c_0</span>,
        )<span class="question-mark">?</span>;

        <span class="comment">// The message recipient calculates the original random bytes and authenticates the result.</span>
        <span class="kw">let</span> <span class="ident">recv_m</span> <span class="op">=</span> <span class="ident">apply_agreement_xor</span>(
            <span class="kw-2">&amp;</span><span class="ident">recipient_identity</span>.<span class="ident">into</span>(),
            <span class="kw-2">&amp;</span><span class="ident">ephemeral_public_key</span>,
            <span class="ident">Direction::Receiving</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_c_0</span>,
        )<span class="question-mark">?</span>;
        <span class="macro">assert_eq!</span>(<span class="kw-2">&amp;</span><span class="ident">recv_m</span>, <span class="kw-2">&amp;</span><span class="ident">m</span>);

        <span class="kw">let</span> <span class="ident">recv_at_0</span> <span class="op">=</span> <span class="ident">compute_authentication_tag</span>(
            <span class="kw-2">&amp;</span><span class="ident">recipient_identity</span>,
            <span class="ident">sender_identity</span>.<span class="ident">identity_key</span>(),
            <span class="ident">Direction::Receiving</span>,
            <span class="kw-2">&amp;</span><span class="ident">ephemeral_public_key</span>,
            <span class="kw-2">&amp;</span><span class="ident">sender_c_0</span>,
        )<span class="question-mark">?</span>;
        <span class="macro">assert_eq!</span>(<span class="kw-2">&amp;</span><span class="ident">recv_at_0</span>, <span class="kw-2">&amp;</span><span class="ident">sender_at_0</span>);

        <span class="prelude-val">Ok</span>(())
    }
}

<span class="doccomment">/// This method implements a single-key multi-recipient [KEM] as defined in Manuel Barbosa&#39;s</span>
<span class="doccomment">/// [&quot;Randomness Reuse: Extensions and Improvements&quot;], a.k.a. Sealed Sender v2.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [KEM]: https://en.wikipedia.org/wiki/Key_encapsulation</span>
<span class="doccomment">/// [&quot;Randomness Reuse: Extensions and Improvements&quot;]: https://haslab.uminho.pt/mbb/files/reuse.pdf</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # Contrast with Sealed Sender v1</span>
<span class="doccomment">/// The KEM scheme implemented by this method uses the &quot;Generic Construction&quot; in `4.1` of [Barbosa&#39;s</span>
<span class="doccomment">/// paper][&quot;Randomness Reuse: Extensions and Improvements&quot;], instantiated with [ElGamal</span>
<span class="doccomment">/// encryption]. This technique enables reusing a single sequence of random bytes across multiple</span>
<span class="doccomment">/// messages with the same content, which reduces computation time for clients sending the same</span>
<span class="doccomment">/// message to multiple recipients (without compromising the message security).</span>
<span class="doccomment">///</span>
<span class="doccomment">/// There are a few additional design tradeoffs this method makes vs [Sealed Sender v1]</span>
<span class="doccomment">/// which may make it comparatively unwieldy for certain scenarios:</span>
<span class="doccomment">/// 1. it requires a [`SessionRecord`] to exist already for the recipient, i.e. that a Double</span>
<span class="doccomment">///    Ratchet message chain has previously been established in the [`SessionStore`] via</span>
<span class="doccomment">///    [`process_prekey_bundle`][crate::process_prekey_bundle] after an initial</span>
<span class="doccomment">///    [`PreKeySignalMessage`][crate::PreKeySignalMessage] is received.</span>
<span class="doccomment">/// 2. it ferries a lot of additional information in its encoding which makes the resulting message</span>
<span class="doccomment">///    bulkier than the message produced by [Sealed Sender v1]. For sending, this will generally</span>
<span class="doccomment">///    still be more compact than sending the same message N times, but on the receiver side the</span>
<span class="doccomment">///    message is slightly larger.</span>
<span class="doccomment">/// 3. unlike other message types sent over the wire, the encoded message returned by this method</span>
<span class="doccomment">///    does not use protobuf, in order to avoid inefficiencies produced by protobuf&#39;s packing (see</span>
<span class="doccomment">///    **[Wire Format]**).</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [ElGamal encryption]: https://en.wikipedia.org/wiki/ElGamal_encryption</span>
<span class="doccomment">/// [Sealed Sender v1]: sealed_sender_encrypt_from_usmc</span>
<span class="doccomment">/// [Wire Format]: #wire-format</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # High-level algorithmic overview</span>
<span class="doccomment">/// The high-level steps of this process are summarized below:</span>
<span class="doccomment">/// 1. Generate a series of random bytes.</span>
<span class="doccomment">/// 2. Derive an ephemeral key pair from (1).</span>
<span class="doccomment">/// 3. *Once per recipient:* Encrypt (1) using a shared secret derived from the private ephemeral</span>
<span class="doccomment">///    key (2) and the recipient&#39;s public identity key.</span>
<span class="doccomment">/// 4. *Once per recipient:* Add an authentication tag for (3) using a secret derived from the</span>
<span class="doccomment">///    sender&#39;s private identity key and the recipient&#39;s public identity key.</span>
<span class="doccomment">/// 5. Generate a symmetric key from (1) and use it to symmetrically encrypt the underlying</span>
<span class="doccomment">///    [`UnidentifiedSenderMessageContent`] via [AEAD encryption]. *This step is only performed once</span>
<span class="doccomment">///    per message, regardless of the number of recipients.*</span>
<span class="doccomment">/// 6. Send the public ephemeral key (2) to the server, along with the sequence of encrypted random</span>
<span class="doccomment">///    bytes (3) and authentication tags (4), and the single encrypted message (5).</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [AEAD encryption]: https://en.wikipedia.org/wiki/Authenticated_encryption#Authenticated_encryption_with_associated_data_(AEAD)</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ## Pseudocode</span>
<span class="doccomment">///```text</span>
<span class="doccomment">/// ENCRYPT(message, R_i):</span>
<span class="doccomment">///     M = Random(32)</span>
<span class="doccomment">///     r = KDF(label_r, M, len=64)</span>
<span class="doccomment">///     K = KDF(label_K, M, len=32)</span>
<span class="doccomment">///     E = DeriveKeyPair(r)</span>
<span class="doccomment">///     for i in num_recipients:</span>
<span class="doccomment">///         C_i = KDF(label_DH, DH(E, R_i) || E.public || R_i.public, len=32) XOR M</span>
<span class="doccomment">///         AT_i = KDF(label_DH_s, DH(S, R_i) || E.public || C_i || S.public || R_i.public, len=16)</span>
<span class="doccomment">///     ciphertext = AEAD_Encrypt(K, message)</span>
<span class="doccomment">///     return E.public, C_i, AT_i, ciphertext</span>
<span class="doccomment">///</span>
<span class="doccomment">/// DECRYPT(E.public, C, AT, ciphertext):</span>
<span class="doccomment">///     M = KDF(label_DH, DH(E, R) || E.public || R.public, len=32) xor C</span>
<span class="doccomment">///     r = KDF(label_r, M, len=64)</span>
<span class="doccomment">///     K = KDF(label_K, M, len=32)</span>
<span class="doccomment">///     E&#39; = DeriveKeyPair(r)</span>
<span class="doccomment">///     if E.public != E&#39;.public:</span>
<span class="doccomment">///         return DecryptionError</span>
<span class="doccomment">///     message = AEAD_Decrypt(K, ciphertext) // includes S.public</span>
<span class="doccomment">///     AT&#39; = KDF(label_DH_s, DH(S, R) || E.public || C || S.public || R.public, len=16)</span>
<span class="doccomment">///     if AT != AT&#39;:</span>
<span class="doccomment">///         return DecryptionError</span>
<span class="doccomment">///     return message</span>
<span class="doccomment">///```</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # Routing messages to recipients</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The server will split up the set of messages and securely route each individual [received</span>
<span class="doccomment">/// message][receiving] to its intended recipient.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// For testing purposes, [`sealed_sender_multi_recipient_fan_out`] can be used to convert such</span>
<span class="doccomment">/// a bulk message produced by Sealed Sender v2 into a sequence of [received messages][receiving];</span>
<span class="doccomment">/// however, in doing so it will drop all of the metadata necessary to identify the message&#39;s</span>
<span class="doccomment">/// intended recipients.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// # Wire Format</span>
<span class="doccomment">/// Multi-recipient sealed-sender does not use protobufs for its payload format. Instead, it uses</span>
<span class="doccomment">/// a flat format marked with a [version byte](#the-version-byte). The format is different for</span>
<span class="doccomment">/// [sending] and [receiving]. The decrypted content is</span>
<span class="doccomment">/// a protobuf-encoded `UnidentifiedSenderMessage.Message` from `sealed_sender.proto`.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The public key used in Sealed Sender v2 is always a Curve25519 DJB key.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [sending]: #sent-messages</span>
<span class="doccomment">/// [receiving]: #received-messages</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ## The version byte</span>
<span class="doccomment">///</span>
<span class="doccomment">/// Sealed sender messages (v1 and v2) in serialized form begin with a version [byte][u8].</span>
<span class="doccomment">/// This byte has the form:</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ```text</span>
<span class="doccomment">/// (requiredVersion &lt;&lt; 4) | currentVersion</span>
<span class="doccomment">/// ```</span>
<span class="doccomment">///</span>
<span class="doccomment">/// v1 messages thus have a version byte of `0x11`. v2 messages have a version byte</span>
<span class="doccomment">/// of `0x22`. A hypothetical version byte `0x34` would indicate a message encoded</span>
<span class="doccomment">/// as Sealed Sender v4, but decodable by any client that supports Sealed Sender v3.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ## Received messages</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ```text</span>
<span class="doccomment">/// ReceivedMessage {</span>
<span class="doccomment">///     version_byte: u8,</span>
<span class="doccomment">///     c: [u8; 32],</span>
<span class="doccomment">///     at: [u8; 16],</span>
<span class="doccomment">///     e_pub: [u8; 32],</span>
<span class="doccomment">///     message: [u8] // remaining bytes</span>
<span class="doccomment">/// }</span>
<span class="doccomment">/// ```</span>
<span class="doccomment">///</span>
<span class="doccomment">/// Each individual Sealed Sender message received from the server is decoded in the Signal</span>
<span class="doccomment">/// client by calling [`sealed_sender_decrypt`].</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ## Sent messages</span>
<span class="doccomment">///</span>
<span class="doccomment">/// ```text</span>
<span class="doccomment">/// PerRecipientData {</span>
<span class="doccomment">///     uuid: [u8; 16],</span>
<span class="doccomment">///     device_id: varint,</span>
<span class="doccomment">///     registration_id: u16,</span>
<span class="doccomment">///     c: [u8; 32],</span>
<span class="doccomment">///     at: [u8; 16],</span>
<span class="doccomment">/// }</span>
<span class="doccomment">///</span>
<span class="doccomment">/// SentMessage {</span>
<span class="doccomment">///     version_byte: u8,</span>
<span class="doccomment">///     count: varint,</span>
<span class="doccomment">///     recipients: [PerRecipientData; count],</span>
<span class="doccomment">///     e_pub: [u8; 32],</span>
<span class="doccomment">///     message: [u8] // remaining bytes</span>
<span class="doccomment">/// }</span>
<span class="doccomment">/// ```</span>
<span class="doccomment">///</span>
<span class="doccomment">/// The varint encoding used is the same as [protobuf&#39;s][varint]. Values are unsigned. UUIDs are</span>
<span class="doccomment">/// encoded per [RFC 4122], with the first eight bytes considered &quot;most significant&quot;. [^1]</span>
<span class="doccomment">/// Fixed-width integers are unaligned and in network byte order (big-endian).</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [varint]: https://developers.google.com/protocol-buffers/docs/encoding#varints</span>
<span class="doccomment">/// [RFC 4122]: https://tools.ietf.org/html/rfc4122#section-4.1.2</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [^1]: RFC 4122 guarantees the encoding order of the fields in a</span>
<span class="doccomment">/// UUID, but the representation of each field may vary based on the UUID&#39;s</span>
<span class="doccomment">/// &quot;variant&quot;. For Sealed Sender&#39;s purposes, this is not important except for</span>
<span class="doccomment">/// debug-printing, since UUIDs are always treated as opaque identifiers matched</span>
<span class="doccomment">/// byte-for-byte.</span>
<span class="kw">pub</span> <span class="kw">async</span> <span class="kw">fn</span> <span class="ident">sealed_sender_multi_recipient_encrypt</span><span class="op">&lt;</span><span class="ident">R</span>: <span class="ident">Rng</span> <span class="op">+</span> <span class="ident">CryptoRng</span><span class="op">&gt;</span>(
    <span class="ident">destinations</span>: <span class="kw-2">&amp;</span>[<span class="kw-2">&amp;</span><span class="ident">ProtocolAddress</span>],
    <span class="ident">destination_sessions</span>: <span class="kw-2">&amp;</span>[<span class="kw-2">&amp;</span><span class="ident">SessionRecord</span>],
    <span class="ident">usmc</span>: <span class="kw-2">&amp;</span><span class="ident">UnidentifiedSenderMessageContent</span>,
    <span class="ident">identity_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">IdentityKeyStore</span>,
    <span class="ident">ctx</span>: <span class="ident">Context</span>,
    <span class="ident">rng</span>: <span class="kw-2">&amp;mut</span> <span class="ident">R</span>,
) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span> {
    <span class="kw">if</span> <span class="ident">destinations</span>.<span class="ident">len</span>() <span class="op">!</span><span class="op">=</span> <span class="ident">destination_sessions</span>.<span class="ident">len</span>() {
        <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidArgument</span>(
            <span class="string">&quot;must have the same number of destination sessions as addresses&quot;</span>.<span class="ident">to_string</span>(),
        ));
    }

    <span class="kw">let</span> <span class="ident">m</span>: [<span class="ident">u8</span>; <span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span>] <span class="op">=</span> <span class="ident">rng</span>.<span class="ident">gen</span>();
    <span class="kw">let</span> <span class="ident">keys</span> <span class="op">=</span> <span class="ident">sealed_sender_v2::DerivedKeys::calculate</span>(<span class="kw-2">&amp;</span><span class="ident">m</span>);
    <span class="kw">let</span> <span class="ident">e_pub</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">keys</span>.<span class="ident">e</span>.<span class="ident">public_key</span>;

    <span class="kw">let</span> <span class="ident">ciphertext</span> <span class="op">=</span> {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ciphertext</span> <span class="op">=</span> <span class="ident">usmc</span>.<span class="ident">serialized</span>()<span class="question-mark">?</span>.<span class="ident">to_vec</span>();
        <span class="kw">let</span> <span class="ident">symmetric_authentication_tag</span> <span class="op">=</span> <span class="ident">Aes256GcmSiv::new_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">keys</span>.<span class="ident">k</span>)
            .<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">aes_gcm_siv</span><span class="op">|</span> {
                <span class="ident">aes_gcm_siv</span>.<span class="ident">encrypt_in_place_detached</span>(
                    <span class="comment">// There&#39;s no nonce because the key is already one-use.</span>
                    <span class="kw-2">&amp;</span><span class="ident">aes_gcm_siv::Nonce::default</span>(),
                    <span class="comment">// And there&#39;s no associated data.</span>
                    <span class="kw-2">&amp;</span>[],
                    <span class="kw-2">&amp;mut</span> <span class="ident">ciphertext</span>,
                )
            })
            .<span class="ident">expect</span>(<span class="string">&quot;AES-GCM-SIV encryption should not fail with a just-computed key&quot;</span>);
        <span class="comment">// AES-GCM-SIV expects the authentication tag to be at the end of the ciphertext</span>
        <span class="comment">// when decrypting.</span>
        <span class="ident">ciphertext</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">symmetric_authentication_tag</span>);
        <span class="ident">ciphertext</span>
    };

    <span class="comment">// Uses a flat representation: count || UUID_i || deviceId_i || registrationId_i || C_i || AT_i || ... || E.pub || ciphertext</span>
    <span class="kw">let</span> <span class="ident">version</span> <span class="op">=</span> <span class="ident">SEALED_SENDER_V2_VERSION</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">serialized</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec!</span>[(<span class="ident">version</span> <span class="op">|</span> (<span class="ident">version</span> <span class="op">&lt;</span><span class="op">&lt;</span> <span class="number">4</span>))];

    <span class="ident">prost::encode_length_delimiter</span>(<span class="ident">destinations</span>.<span class="ident">len</span>(), <span class="kw-2">&amp;mut</span> <span class="ident">serialized</span>)
        .<span class="ident">expect</span>(<span class="string">&quot;cannot fail encoding to Vec&quot;</span>);

    <span class="kw">let</span> <span class="ident">our_identity</span> <span class="op">=</span> <span class="ident">identity_store</span>.<span class="ident">get_identity_key_pair</span>(<span class="ident">ctx</span>).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">previous_their_identity</span> <span class="op">=</span> <span class="prelude-val">None</span>;
    <span class="kw">for</span> (<span class="kw-2">&amp;</span><span class="ident">destination</span>, <span class="ident">session</span>) <span class="kw">in</span> <span class="ident">destinations</span>.<span class="ident">iter</span>().<span class="ident">zip</span>(<span class="ident">destination_sessions</span>) {
        <span class="kw">let</span> <span class="ident">their_uuid</span> <span class="op">=</span> <span class="ident">Uuid::parse_str</span>(<span class="ident">destination</span>.<span class="ident">name</span>()).<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> {
            <span class="ident">SignalProtocolError::InvalidArgument</span>(<span class="macro">format!</span>(
                <span class="string">&quot;multi-recipient sealed sender requires UUID recipients (not {})&quot;</span>,
                <span class="ident">destination</span>.<span class="ident">name</span>()
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">their_identity</span> <span class="op">=</span> <span class="ident">identity_store</span>
            .<span class="ident">get_identity</span>(<span class="ident">destination</span>, <span class="ident">ctx</span>)
            .<span class="kw">await</span><span class="question-mark">?</span>
            .<span class="ident">ok_or_else</span>(<span class="op">|</span><span class="op">|</span> {
                <span class="macro">log::error!</span>(<span class="string">&quot;missing identity key for {}&quot;</span>, <span class="ident">destination</span>);
                <span class="comment">// Returned as a SessionNotFound error because (a) we don&#39;t have an identity error</span>
                <span class="comment">// that includes the address, and (b) re-establishing the session should re-fetch</span>
                <span class="comment">// the identity.</span>
                <span class="ident">SignalProtocolError::SessionNotFound</span>(<span class="ident">destination</span>.<span class="ident">clone</span>())
            })<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="ident">their_registration_id</span> <span class="op">=</span> <span class="ident">session</span>.<span class="ident">remote_registration_id</span>().<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> {
            <span class="ident">SignalProtocolError::InvalidState</span>(
                <span class="string">&quot;sealed_sender_multi_recipient_encrypt&quot;</span>,
                <span class="macro">format!</span>(
                    <span class="macro">concat!</span>(
                        <span class="string">&quot;cannot get registration ID from session with {} &quot;</span>,
                        <span class="string">&quot;(maybe it was recently archived)&quot;</span>
                    ),
                    <span class="ident">destination</span>
                ),
            )
        })<span class="question-mark">?</span>;
        <span class="comment">// Valid registration IDs fit in 14 bits.</span>
        <span class="comment">// TODO: move this into a RegistrationId strong type.</span>
        <span class="kw">if</span> <span class="ident">their_registration_id</span> <span class="op">&amp;</span> <span class="number">0x3FFF</span> <span class="op">!</span><span class="op">=</span> <span class="ident">their_registration_id</span> {
            <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidRegistrationId</span>(
                <span class="ident">destination</span>.<span class="ident">clone</span>(),
                <span class="ident">their_registration_id</span>,
            ));
        }
        <span class="kw">let</span> <span class="ident">their_registration_id</span> <span class="op">=</span>
            <span class="ident">u16::try_from</span>(<span class="ident">their_registration_id</span>).<span class="ident">expect</span>(<span class="string">&quot;just checked range&quot;</span>);

        <span class="kw">let</span> <span class="ident">end_of_previous_recipient_data</span> <span class="op">=</span> <span class="ident">serialized</span>.<span class="ident">len</span>();

        <span class="ident">serialized</span>.<span class="ident">extend_from_slice</span>(<span class="ident">their_uuid</span>.<span class="ident">as_bytes</span>());
        <span class="ident">prost::encode_length_delimiter</span>(<span class="ident">destination</span>.<span class="ident">device_id</span>() <span class="kw">as</span> <span class="ident">usize</span>, <span class="kw-2">&amp;mut</span> <span class="ident">serialized</span>)
            .<span class="ident">expect</span>(<span class="string">&quot;cannot fail encoding to Vec&quot;</span>);
        <span class="ident">serialized</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">their_registration_id</span>.<span class="ident">to_be_bytes</span>());

        <span class="kw">if</span> <span class="prelude-val">Some</span>(<span class="ident">their_identity</span>) <span class="op">==</span> <span class="ident">previous_their_identity</span> {
            <span class="comment">// We often send to the same user multiple times, once per device.</span>
            <span class="comment">// Since the encoding of the message key and attachment tag only depends</span>
            <span class="comment">// on the identity key, we can reuse the work from the previous destination.</span>
            <span class="kw">let</span> <span class="ident">start_of_previous_recipient_c_and_at</span> <span class="op">=</span> <span class="ident">end_of_previous_recipient_data</span>
                <span class="op">-</span> <span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span>
                <span class="op">-</span> <span class="ident">sealed_sender_v2::AUTH_TAG_LEN</span>;
            <span class="ident">serialized</span>.<span class="ident">extend_from_within</span>(
                <span class="ident">start_of_previous_recipient_c_and_at</span>..<span class="ident">end_of_previous_recipient_data</span>,
            )
        } <span class="kw">else</span> {
            <span class="kw">let</span> <span class="ident">c_i</span> <span class="op">=</span> <span class="ident">sealed_sender_v2::apply_agreement_xor</span>(
                <span class="kw-2">&amp;</span><span class="ident">keys</span>.<span class="ident">e</span>,
                <span class="ident">their_identity</span>.<span class="ident">public_key</span>(),
                <span class="ident">Direction::Sending</span>,
                <span class="kw-2">&amp;</span><span class="ident">m</span>,
            )<span class="question-mark">?</span>;
            <span class="ident">serialized</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">c_i</span>);

            <span class="kw">let</span> <span class="ident">at_i</span> <span class="op">=</span> <span class="ident">sealed_sender_v2::compute_authentication_tag</span>(
                <span class="kw-2">&amp;</span><span class="ident">our_identity</span>,
                <span class="kw-2">&amp;</span><span class="ident">their_identity</span>,
                <span class="ident">Direction::Sending</span>,
                <span class="ident">e_pub</span>,
                <span class="kw-2">&amp;</span><span class="ident">c_i</span>,
            )<span class="question-mark">?</span>;
            <span class="ident">serialized</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">at_i</span>);
        }

        <span class="ident">previous_their_identity</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">their_identity</span>);
    }

    <span class="ident">serialized</span>.<span class="ident">extend_from_slice</span>(<span class="ident">e_pub</span>.<span class="ident">public_key_bytes</span>()<span class="question-mark">?</span>);
    <span class="ident">serialized</span>.<span class="ident">extend_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">ciphertext</span>);

    <span class="prelude-val">Ok</span>(<span class="ident">serialized</span>)
}

<span class="doccomment">/// Split out the encoded message from [`sealed_sender_multi_recipient_encrypt`] into a sequence of</span>
<span class="doccomment">/// individual encrypted [`UnidentifiedSenderMessageContent`]s. **Note: this method is only used in</span>
<span class="doccomment">/// testing.**</span>
<span class="doccomment">///</span>
<span class="doccomment">/// This method strips recipients&#39; metadata and splits a bulk v2 sealed-sender message into byte</span>
<span class="doccomment">/// strings which can be processed by [`sealed_sender_decrypt_to_usmc`]. For the Signal app, this</span>
<span class="doccomment">/// process of splitting out a v2 sealed-sender message into individual messages and using the</span>
<span class="doccomment">/// metadata to correctly route the result to recipients is performed by the Signal server (see</span>
<span class="doccomment">/// **[Routing messages to recipients]**).</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [Routing messages to recipients]: sealed_sender_multi_recipient_encrypt#routing-messages-to-recipients</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sealed_sender_multi_recipient_fan_out</span>(<span class="ident">data</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">version</span> <span class="op">=</span> <span class="ident">data</span>[<span class="number">0</span>] <span class="op">&gt;</span><span class="op">&gt;</span> <span class="number">4</span>;
    <span class="kw">if</span> <span class="ident">version</span> <span class="op">!</span><span class="op">=</span> <span class="ident">SEALED_SENDER_V2_VERSION</span> {
        <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::UnknownSealedSenderVersion</span>(<span class="ident">version</span>));
    }

    <span class="kw">fn</span> <span class="ident">advance</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span>(<span class="ident">buf</span>: <span class="kw-2">&amp;mut</span> <span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> [<span class="ident">u8</span>], <span class="ident">n</span>: <span class="ident">usize</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> [<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="ident">n</span> <span class="op">&gt;</span> <span class="ident">buf</span>.<span class="ident">len</span>() {
            <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>);
        }
        <span class="kw">let</span> (<span class="ident">prefix</span>, <span class="ident">remaining</span>) <span class="op">=</span> <span class="ident">buf</span>.<span class="ident">split_at</span>(<span class="ident">n</span>);
        <span class="kw-2">*</span><span class="ident">buf</span> <span class="op">=</span> <span class="ident">remaining</span>;
        <span class="prelude-val">Ok</span>(<span class="ident">prefix</span>)
    }
    <span class="kw">fn</span> <span class="ident">decode_varint</span>(<span class="ident">buf</span>: <span class="kw-2">&amp;mut</span> <span class="kw-2">&amp;</span>[<span class="ident">u8</span>]) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
        <span class="kw">let</span> <span class="ident">result</span>: <span class="ident">usize</span> <span class="op">=</span> <span class="ident">prost::decode_length_delimiter</span>(<span class="kw-2">*</span><span class="ident">buf</span>)
            .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="kw">_</span> <span class="op">=</span> <span class="ident">advance</span>(<span class="ident">buf</span>, <span class="ident">prost::length_delimiter_len</span>(<span class="ident">result</span>))
            .<span class="ident">expect</span>(<span class="string">&quot;just decoded that many bytes&quot;</span>);
        <span class="ident">result</span>
            .<span class="ident">try_into</span>()
            .<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">SignalProtocolError::InvalidProtobufEncoding</span>)
    }

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">remaining</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">data</span>[<span class="number">1</span>..];
    <span class="kw">let</span> <span class="ident">recipient_count</span> <span class="op">=</span> <span class="ident">decode_varint</span>(<span class="kw-2">&amp;mut</span> <span class="ident">remaining</span>)<span class="question-mark">?</span>;

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">messages</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec::new</span>();
    <span class="kw">for</span> <span class="kw">_</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">recipient_count</span> {
        <span class="comment">// Skip UUID.</span>
        <span class="kw">let</span> <span class="kw">_</span> <span class="op">=</span> <span class="ident">advance</span>(<span class="kw-2">&amp;mut</span> <span class="ident">remaining</span>, <span class="number">16</span>)<span class="question-mark">?</span>;
        <span class="comment">// Skip device ID.</span>
        <span class="kw">let</span> <span class="kw">_</span> <span class="op">=</span> <span class="ident">decode_varint</span>(<span class="kw-2">&amp;mut</span> <span class="ident">remaining</span>)<span class="question-mark">?</span>;
        <span class="comment">// Skip registration ID.</span>
        <span class="kw">let</span> <span class="kw">_</span> <span class="op">=</span> <span class="ident">advance</span>(<span class="kw-2">&amp;mut</span> <span class="ident">remaining</span>, <span class="number">2</span>)<span class="question-mark">?</span>;
        <span class="comment">// Read C_i and AT_i.</span>
        <span class="kw">let</span> <span class="ident">c_and_at</span> <span class="op">=</span> <span class="ident">advance</span>(
            <span class="kw-2">&amp;mut</span> <span class="ident">remaining</span>,
            <span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span> <span class="op">+</span> <span class="ident">sealed_sender_v2::AUTH_TAG_LEN</span>,
        )<span class="question-mark">?</span>;

        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">next_message</span> <span class="op">=</span> <span class="macro">vec!</span>[<span class="ident">data</span>[<span class="number">0</span>]];
        <span class="ident">next_message</span>.<span class="ident">extend_from_slice</span>(<span class="ident">c_and_at</span>);
        <span class="ident">messages</span>.<span class="ident">push</span>(<span class="ident">next_message</span>);
    }

    <span class="comment">// Remaining data is shared among all messages.</span>
    <span class="kw">for</span> <span class="ident">message</span> <span class="kw">in</span> <span class="ident">messages</span>.<span class="ident">iter_mut</span>() {
        <span class="ident">message</span>.<span class="ident">extend_from_slice</span>(<span class="ident">remaining</span>)
    }

    <span class="prelude-val">Ok</span>(<span class="ident">messages</span>)
}

<span class="doccomment">/// Decrypt the payload of a sealed-sender message in either the v1 or v2 format.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// [`sealed_sender_decrypt`] consumes the output of this method to validate the sender&#39;s identity</span>
<span class="doccomment">/// before decrypting the underlying message.</span>
<span class="kw">pub</span> <span class="kw">async</span> <span class="kw">fn</span> <span class="ident">sealed_sender_decrypt_to_usmc</span>(
    <span class="ident">ciphertext</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>],
    <span class="ident">identity_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">IdentityKeyStore</span>,
    <span class="ident">ctx</span>: <span class="ident">Context</span>,
) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">UnidentifiedSenderMessageContent</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">our_identity</span> <span class="op">=</span> <span class="ident">identity_store</span>.<span class="ident">get_identity_key_pair</span>(<span class="ident">ctx</span>).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="kw">match</span> <span class="ident">UnidentifiedSenderMessage::deserialize</span>(<span class="ident">ciphertext</span>)<span class="question-mark">?</span> {
        <span class="ident">UnidentifiedSenderMessage::V1</span> {
            <span class="ident">ephemeral_public</span>,
            <span class="ident">encrypted_static</span>,
            <span class="ident">encrypted_message</span>,
        } =&gt; {
            <span class="kw">let</span> <span class="ident">eph_keys</span> <span class="op">=</span> <span class="ident">sealed_sender_v1::EphemeralKeys::calculate</span>(
                <span class="kw-2">&amp;</span><span class="ident">our_identity</span>.<span class="ident">into</span>(),
                <span class="kw-2">&amp;</span><span class="ident">ephemeral_public</span>,
                <span class="ident">Direction::Receiving</span>,
            )<span class="question-mark">?</span>;

            <span class="kw">let</span> <span class="ident">message_key_bytes</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">crypto::aes256_ctr_hmacsha256_decrypt</span>(
                <span class="kw-2">&amp;</span><span class="ident">encrypted_static</span>,
                <span class="kw-2">&amp;</span><span class="ident">eph_keys</span>.<span class="ident">cipher_key</span>,
                <span class="kw-2">&amp;</span><span class="ident">eph_keys</span>.<span class="ident">mac_key</span>,
            ) {
                <span class="prelude-val">Ok</span>(<span class="ident">plaintext</span>) =&gt; <span class="ident">plaintext</span>,
                <span class="prelude-val">Err</span>(<span class="ident">crypto::DecryptionError::BadKeyOrIv</span>) =&gt; {
                    <span class="macro">unreachable!</span>(<span class="string">&quot;just derived these keys; they should be valid&quot;</span>);
                }
                <span class="prelude-val">Err</span>(<span class="ident">crypto::DecryptionError::BadCiphertext</span>(<span class="ident">msg</span>)) =&gt; {
                    <span class="macro">log::error!</span>(<span class="string">&quot;failed to decrypt sealed sender v1 message key: {}&quot;</span>, <span class="ident">msg</span>);
                    <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
                        <span class="string">&quot;failed to decrypt sealed sender v1 message key&quot;</span>.<span class="ident">to_owned</span>(),
                    ));
                }
            };

            <span class="kw">let</span> <span class="ident">static_key</span> <span class="op">=</span> <span class="ident">PublicKey::try_from</span>(<span class="kw-2">&amp;</span><span class="ident">message_key_bytes</span>[..])<span class="question-mark">?</span>;

            <span class="kw">let</span> <span class="ident">static_keys</span> <span class="op">=</span> <span class="ident">sealed_sender_v1::StaticKeys::calculate</span>(
                <span class="kw-2">&amp;</span><span class="ident">our_identity</span>,
                <span class="kw-2">&amp;</span><span class="ident">static_key</span>,
                <span class="kw-2">&amp;</span><span class="ident">eph_keys</span>.<span class="ident">chain_key</span>,
                <span class="kw-2">&amp;</span><span class="ident">encrypted_static</span>,
            )<span class="question-mark">?</span>;

            <span class="kw">let</span> <span class="ident">message_bytes</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">crypto::aes256_ctr_hmacsha256_decrypt</span>(
                <span class="kw-2">&amp;</span><span class="ident">encrypted_message</span>,
                <span class="kw-2">&amp;</span><span class="ident">static_keys</span>.<span class="ident">cipher_key</span>,
                <span class="kw-2">&amp;</span><span class="ident">static_keys</span>.<span class="ident">mac_key</span>,
            ) {
                <span class="prelude-val">Ok</span>(<span class="ident">plaintext</span>) =&gt; <span class="ident">plaintext</span>,
                <span class="prelude-val">Err</span>(<span class="ident">crypto::DecryptionError::BadKeyOrIv</span>) =&gt; {
                    <span class="macro">unreachable!</span>(<span class="string">&quot;just derived these keys; they should be valid&quot;</span>);
                }
                <span class="prelude-val">Err</span>(<span class="ident">crypto::DecryptionError::BadCiphertext</span>(<span class="ident">msg</span>)) =&gt; {
                    <span class="macro">log::error!</span>(
                        <span class="string">&quot;failed to decrypt sealed sender v1 message contents: {}&quot;</span>,
                        <span class="ident">msg</span>
                    );
                    <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
                        <span class="string">&quot;failed to decrypt sealed sender v1 message contents&quot;</span>.<span class="ident">to_owned</span>(),
                    ));
                }
            };

            <span class="kw">let</span> <span class="ident">usmc</span> <span class="op">=</span> <span class="ident">UnidentifiedSenderMessageContent::deserialize</span>(<span class="kw-2">&amp;</span><span class="ident">message_bytes</span>)<span class="question-mark">?</span>;

            <span class="kw">if</span> <span class="op">!</span><span class="ident">bool::from</span>(<span class="ident">message_key_bytes</span>.<span class="ident">ct_eq</span>(<span class="kw-2">&amp;</span><span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">key</span>()<span class="question-mark">?</span>.<span class="ident">serialize</span>())) {
                <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
                    <span class="string">&quot;sender certificate key does not match message key&quot;</span>.<span class="ident">to_string</span>(),
                ));
            }

            <span class="prelude-val">Ok</span>(<span class="ident">usmc</span>)
        }
        <span class="ident">UnidentifiedSenderMessage::V2</span> {
            <span class="ident">ephemeral_public</span>,
            <span class="ident">encrypted_message_key</span>,
            <span class="ident">authentication_tag</span>,
            <span class="ident">encrypted_message</span>,
        } =&gt; {
            <span class="kw">let</span> <span class="ident">encrypted_message_key</span>: [<span class="ident">u8</span>; <span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span>] <span class="op">=</span>
                <span class="ident">encrypted_message_key</span>.<span class="ident">as_ref</span>().<span class="ident">try_into</span>().<span class="ident">map_err</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> {
                    <span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(<span class="macro">format!</span>(
                        <span class="string">&quot;encrypted message key had incorrect length {} (should be {})&quot;</span>,
                        <span class="ident">encrypted_message_key</span>.<span class="ident">len</span>(),
                        <span class="ident">sealed_sender_v2::MESSAGE_KEY_LEN</span>
                    ))
                })<span class="question-mark">?</span>;
            <span class="kw">let</span> <span class="ident">m</span> <span class="op">=</span> <span class="ident">sealed_sender_v2::apply_agreement_xor</span>(
                <span class="kw-2">&amp;</span><span class="ident">our_identity</span>.<span class="ident">into</span>(),
                <span class="kw-2">&amp;</span><span class="ident">ephemeral_public</span>,
                <span class="ident">Direction::Receiving</span>,
                <span class="kw-2">&amp;</span><span class="ident">encrypted_message_key</span>,
            )<span class="question-mark">?</span>;

            <span class="kw">let</span> <span class="ident">keys</span> <span class="op">=</span> <span class="ident">sealed_sender_v2::DerivedKeys::calculate</span>(<span class="kw-2">&amp;</span><span class="ident">m</span>);
            <span class="kw">if</span> <span class="op">!</span><span class="ident">bool::from</span>(<span class="ident">keys</span>.<span class="ident">e</span>.<span class="ident">public_key</span>.<span class="ident">ct_eq</span>(<span class="kw-2">&amp;</span><span class="ident">ephemeral_public</span>)) {
                <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
                    <span class="string">&quot;derived ephemeral key did not match key provided in message&quot;</span>.<span class="ident">to_string</span>(),
                ));
            }

            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">message_bytes</span> <span class="op">=</span> <span class="ident">encrypted_message</span>.<span class="ident">into_vec</span>();
            <span class="ident">Aes256GcmSiv::new_from_slice</span>(<span class="kw-2">&amp;</span><span class="ident">keys</span>.<span class="ident">k</span>)
                .<span class="ident">and_then</span>(<span class="op">|</span><span class="ident">aes_gcm_siv</span><span class="op">|</span> {
                    <span class="ident">aes_gcm_siv</span>.<span class="ident">decrypt_in_place</span>(
                        <span class="comment">// There&#39;s no nonce because the key is already one-use.</span>
                        <span class="kw-2">&amp;</span><span class="ident">aes_gcm_siv::Nonce::default</span>(),
                        <span class="comment">// And there&#39;s no associated data.</span>
                        <span class="kw-2">&amp;</span>[],
                        <span class="kw-2">&amp;mut</span> <span class="ident">message_bytes</span>,
                    )
                })
                .<span class="ident">map_err</span>(<span class="op">|</span><span class="ident">err</span><span class="op">|</span> {
                    <span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(<span class="macro">format!</span>(
                        <span class="string">&quot;failed to decrypt inner message: {}&quot;</span>,
                        <span class="ident">err</span>
                    ))
                })<span class="question-mark">?</span>;

            <span class="kw">let</span> <span class="ident">usmc</span> <span class="op">=</span> <span class="ident">UnidentifiedSenderMessageContent::deserialize</span>(<span class="kw-2">&amp;</span><span class="ident">message_bytes</span>)<span class="question-mark">?</span>;

            <span class="kw">let</span> <span class="ident">at</span> <span class="op">=</span> <span class="ident">sealed_sender_v2::compute_authentication_tag</span>(
                <span class="kw-2">&amp;</span><span class="ident">our_identity</span>,
                <span class="kw-2">&amp;</span><span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">key</span>()<span class="question-mark">?</span>.<span class="ident">into</span>(),
                <span class="ident">Direction::Receiving</span>,
                <span class="kw-2">&amp;</span><span class="ident">ephemeral_public</span>,
                <span class="kw-2">&amp;</span><span class="ident">encrypted_message_key</span>,
            )<span class="question-mark">?</span>;
            <span class="kw">if</span> <span class="op">!</span><span class="ident">bool::from</span>(<span class="ident">authentication_tag</span>.<span class="ident">ct_eq</span>(<span class="kw-2">&amp;</span><span class="ident">at</span>)) {
                <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
                    <span class="string">&quot;sender certificate key does not match authentication tag&quot;</span>.<span class="ident">to_string</span>(),
                ));
            }

            <span class="prelude-val">Ok</span>(<span class="ident">usmc</span>)
        }
    }
}

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Debug</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">SealedSenderDecryptionResult</span> {
    <span class="kw">pub</span> <span class="ident">sender_uuid</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">sender_e164</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">device_id</span>: <span class="ident">u32</span>,
    <span class="kw">pub</span> <span class="ident">message</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>,
}

<span class="kw">impl</span> <span class="ident">SealedSenderDecryptionResult</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sender_uuid</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">str</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">sender_uuid</span>.<span class="ident">as_ref</span>())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">sender_e164</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">str</span><span class="op">&gt;</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">sender_e164</span>.<span class="ident">as_deref</span>())
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">device_id</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">device_id</span>)
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">message</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="kw-2">&amp;</span>[<span class="ident">u8</span>]<span class="op">&gt;</span> {
        <span class="prelude-val">Ok</span>(<span class="self">self</span>.<span class="ident">message</span>.<span class="ident">as_ref</span>())
    }
}

<span class="doccomment">/// Decrypt a Sealed Sender message `ciphertext` in either the v1 or v2 format, validate its sender</span>
<span class="doccomment">/// certificate, and then decrypt the inner message payload.</span>
<span class="doccomment">///</span>
<span class="doccomment">/// This method calls [`sealed_sender_decrypt_to_usmc`] to extract the sender information, including</span>
<span class="doccomment">/// the embedded [`SenderCertificate`]. The sender certificate (signed by the [`ServerCertificate`])</span>
<span class="doccomment">/// is then validated against the `trust_root` baked into the client to ensure that the sender&#39;s</span>
<span class="doccomment">/// identity was not forged.</span>
<span class="attribute">#[<span class="ident">allow</span>(<span class="ident">clippy::too_many_arguments</span>)]</span>
<span class="kw">pub</span> <span class="kw">async</span> <span class="kw">fn</span> <span class="ident">sealed_sender_decrypt</span>(
    <span class="ident">ciphertext</span>: <span class="kw-2">&amp;</span>[<span class="ident">u8</span>],
    <span class="ident">trust_root</span>: <span class="kw-2">&amp;</span><span class="ident">PublicKey</span>,
    <span class="ident">timestamp</span>: <span class="ident">u64</span>,
    <span class="ident">local_e164</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
    <span class="ident">local_uuid</span>: <span class="ident">String</span>,
    <span class="ident">local_device_id</span>: <span class="ident">u32</span>,
    <span class="ident">identity_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">IdentityKeyStore</span>,
    <span class="ident">session_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">SessionStore</span>,
    <span class="ident">pre_key_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">PreKeyStore</span>,
    <span class="ident">signed_pre_key_store</span>: <span class="kw-2">&amp;mut</span> <span class="kw">dyn</span> <span class="ident">SignedPreKeyStore</span>,
    <span class="ident">ctx</span>: <span class="ident">Context</span>,
) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">SealedSenderDecryptionResult</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">usmc</span> <span class="op">=</span> <span class="ident">sealed_sender_decrypt_to_usmc</span>(<span class="ident">ciphertext</span>, <span class="ident">identity_store</span>, <span class="ident">ctx</span>).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="kw">if</span> <span class="op">!</span><span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">validate</span>(<span class="ident">trust_root</span>, <span class="ident">timestamp</span>)<span class="question-mark">?</span> {
        <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidSealedSenderMessage</span>(
            <span class="string">&quot;trust root validation failed&quot;</span>.<span class="ident">to_string</span>(),
        ));
    }

    <span class="kw">let</span> <span class="ident">is_local_uuid</span> <span class="op">=</span> <span class="ident">local_uuid</span> <span class="op">==</span> <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_uuid</span>()<span class="question-mark">?</span>;

    <span class="kw">let</span> <span class="ident">is_local_e164</span> <span class="op">=</span> <span class="kw">match</span> (<span class="ident">local_e164</span>, <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_e164</span>()<span class="question-mark">?</span>) {
        (<span class="prelude-val">Some</span>(<span class="ident">l</span>), <span class="prelude-val">Some</span>(<span class="ident">s</span>)) =&gt; <span class="ident">l</span> <span class="op">==</span> <span class="ident">s</span>,
        (<span class="kw">_</span>, <span class="kw">_</span>) =&gt; <span class="bool-val">false</span>,
    };

    <span class="kw">if</span> (<span class="ident">is_local_e164</span> <span class="op">|</span><span class="op">|</span> <span class="ident">is_local_uuid</span>) <span class="op">&amp;&amp;</span> <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_device_id</span>()<span class="question-mark">?</span> <span class="op">==</span> <span class="ident">local_device_id</span> {
        <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::SealedSenderSelfSend</span>);
    }

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">rng</span> <span class="op">=</span> <span class="ident">rand::rngs::OsRng</span>;

    <span class="kw">let</span> <span class="ident">remote_address</span> <span class="op">=</span> <span class="ident">ProtocolAddress::new</span>(
        <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_uuid</span>()<span class="question-mark">?</span>.<span class="ident">to_string</span>(),
        <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_device_id</span>()<span class="question-mark">?</span>,
    );

    <span class="kw">let</span> <span class="ident">message</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">usmc</span>.<span class="ident">msg_type</span>()<span class="question-mark">?</span> {
        <span class="ident">CiphertextMessageType::Whisper</span> =&gt; {
            <span class="kw">let</span> <span class="ident">ctext</span> <span class="op">=</span> <span class="ident">SignalMessage::try_from</span>(<span class="ident">usmc</span>.<span class="ident">contents</span>()<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            <span class="ident">session_cipher::message_decrypt_signal</span>(
                <span class="kw-2">&amp;</span><span class="ident">ctext</span>,
                <span class="kw-2">&amp;</span><span class="ident">remote_address</span>,
                <span class="ident">session_store</span>,
                <span class="ident">identity_store</span>,
                <span class="kw-2">&amp;mut</span> <span class="ident">rng</span>,
                <span class="ident">ctx</span>,
            )
            .<span class="kw">await</span><span class="question-mark">?</span>
        }
        <span class="ident">CiphertextMessageType::PreKey</span> =&gt; {
            <span class="kw">let</span> <span class="ident">ctext</span> <span class="op">=</span> <span class="ident">PreKeySignalMessage::try_from</span>(<span class="ident">usmc</span>.<span class="ident">contents</span>()<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            <span class="ident">session_cipher::message_decrypt_prekey</span>(
                <span class="kw-2">&amp;</span><span class="ident">ctext</span>,
                <span class="kw-2">&amp;</span><span class="ident">remote_address</span>,
                <span class="ident">session_store</span>,
                <span class="ident">identity_store</span>,
                <span class="ident">pre_key_store</span>,
                <span class="ident">signed_pre_key_store</span>,
                <span class="kw-2">&amp;mut</span> <span class="ident">rng</span>,
                <span class="ident">ctx</span>,
            )
            .<span class="kw">await</span><span class="question-mark">?</span>
        }
        <span class="ident">msg_type</span> =&gt; {
            <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="ident">SignalProtocolError::InvalidMessage</span>(
                <span class="ident">msg_type</span>,
                <span class="string">&quot;unexpected message type for sealed_sender_decrypt&quot;</span>,
            ));
        }
    };

    <span class="prelude-val">Ok</span>(<span class="ident">SealedSenderDecryptionResult</span> {
        <span class="ident">sender_uuid</span>: <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_uuid</span>()<span class="question-mark">?</span>.<span class="ident">to_string</span>(),
        <span class="ident">sender_e164</span>: <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_e164</span>()<span class="question-mark">?</span>.<span class="ident">map</span>(<span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">s</span>.<span class="ident">to_string</span>()),
        <span class="ident">device_id</span>: <span class="ident">usmc</span>.<span class="ident">sender</span>()<span class="question-mark">?</span>.<span class="ident">sender_device_id</span>()<span class="question-mark">?</span>,
        <span class="ident">message</span>,
    })
}

<span class="attribute">#[<span class="ident">test</span>]</span>
<span class="kw">fn</span> <span class="ident">test_lossless_round_trip</span>() -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">trust_root</span> <span class="op">=</span> <span class="ident">PrivateKey::deserialize</span>(<span class="kw-2">&amp;</span>[<span class="number">0u8</span>; <span class="number">32</span>])<span class="question-mark">?</span>;

    <span class="comment">// To test a hypothetical addition of a new field:</span>
    <span class="comment">//</span>
    <span class="comment">// Step 1: temporarily add a new field to the .proto.</span>
    <span class="comment">//</span>
    <span class="comment">//    --- a/rust/protocol/src/proto/sealed_sender.proto</span>
    <span class="comment">//    +++ b/rust/protocol/src/proto/sealed_sender.proto</span>
    <span class="comment">//    @@ -26,3 +26,4 @@ message SenderCertificate {</span>
    <span class="comment">//             optional bytes             identityKey   = 4;</span>
    <span class="comment">//             optional ServerCertificate signer        = 5;</span>
    <span class="comment">//    +        optional string someFakeField = 999;</span>
    <span class="comment">//     }</span>
    <span class="comment">//</span>
    <span class="comment">// Step 2: Add `some_fake_field: None` to the above construction of</span>
    <span class="comment">// proto::sealed_sender::sender_certificate::Certificate.</span>
    <span class="comment">//</span>
    <span class="comment">// Step 3: Serialize and print out the new fixture data (uncomment the following)</span>
    <span class="comment">//</span>
    <span class="comment">// let mut rng = rand::rngs::OsRng;</span>
    <span class="comment">// let server_key = KeyPair::generate(&amp;mut rng);</span>
    <span class="comment">// let sender_key = KeyPair::generate(&amp;mut rng);</span>
    <span class="comment">//</span>
    <span class="comment">// let server_cert =</span>
    <span class="comment">//     ServerCertificate::new(1, server_key.public_key, &amp;trust_root, &amp;mut rng)?;</span>
    <span class="comment">//</span>
    <span class="comment">// let sender_cert = proto::sealed_sender::sender_certificate::Certificate {</span>
    <span class="comment">//     sender_uuid: Some(&quot;aaaaaaaa-7000-11eb-b32a-33b8a8a487a6&quot;.to_string()),</span>
    <span class="comment">//     sender_e164: None,</span>
    <span class="comment">//     sender_device: Some(1),</span>
    <span class="comment">//     expires: Some(31337),</span>
    <span class="comment">//     identity_key: Some(sender_key.public_key.serialize().to_vec()),</span>
    <span class="comment">//     signer: Some(server_cert.to_protobuf()?),</span>
    <span class="comment">//     some_fake_field: Some(&quot;crashing right down&quot;.to_string()),</span>
    <span class="comment">// };</span>
    <span class="comment">//</span>
    <span class="comment">// eprintln!(&quot;&lt;SNIP&gt;&quot;);</span>
    <span class="comment">// let serialized_certificate_data = sender_cert.encode_to_vec();</span>
    <span class="comment">// let certificate_data_encoded = hex::encode(&amp;serialized_certificate_data);</span>
    <span class="comment">// eprintln!(&quot;let certificate_data_encoded = \&quot;{}\&quot;;&quot;, certificate_data_encoded);</span>
    <span class="comment">//</span>
    <span class="comment">// let certificate_signature = server_key.calculate_signature(&amp;serialized_certificate_data, &amp;mut rng)?;</span>
    <span class="comment">// let certificate_signature_encoded = hex::encode(certificate_signature);</span>
    <span class="comment">// eprintln!(&quot;let certificate_signature_encoded = \&quot;{}\&quot;;&quot;, certificate_signature_encoded);</span>

    <span class="comment">// Step 4: update the following *_encoded fixture data with the new values from above.</span>
    <span class="kw">let</span> <span class="ident">certificate_data_encoded</span> <span class="op">=</span> <span class="string">&quot;100119697a0000000000002221056c9d1f8deb82b9a898f9c277a1b74989ec009afb5c0acb5e8e69e3d5ca29d6322a690a2508011221053b03ca070e6f6b2f271d32f27321689cdf4e59b106c10b58fbe15063ed868a5a124024bc92954e52ad1a105b5bda85c9db410dcfeb42a671b45a523b3a46e9594a8bde0efc671d8e8e046b32c67f59b80a46ffdf24071850779bc21325107902af89322461616161616161612d373030302d313165622d623332612d333362386138613438376136ba3e136372617368696e6720726967687420646f776e&quot;</span>;
    <span class="kw">let</span> <span class="ident">certificate_signature_encoded</span> <span class="op">=</span> <span class="string">&quot;a22d8f86f5d00794f319add821e342c6ffffb6b34f741e569f8b321ab0255f2d1757ecf648e53a3602cae8f09b3fc80dcf27534d67efd272b6739afc31f75c8c&quot;</span>;

    <span class="comment">// The rest of the test should be stable.</span>
    <span class="kw">let</span> <span class="ident">certificate_data</span> <span class="op">=</span> <span class="ident">hex::decode</span>(<span class="ident">certificate_data_encoded</span>).<span class="ident">expect</span>(<span class="string">&quot;valid hex&quot;</span>);
    <span class="kw">let</span> <span class="ident">certificate_signature</span> <span class="op">=</span> <span class="ident">hex::decode</span>(<span class="ident">certificate_signature_encoded</span>).<span class="ident">expect</span>(<span class="string">&quot;valid hex&quot;</span>);

    <span class="kw">let</span> <span class="ident">sender_certificate_data</span> <span class="op">=</span> <span class="ident">proto::sealed_sender::SenderCertificate</span> {
        <span class="ident">certificate</span>: <span class="prelude-val">Some</span>(<span class="ident">certificate_data</span>),
        <span class="ident">signature</span>: <span class="prelude-val">Some</span>(<span class="ident">certificate_signature</span>),
    };

    <span class="kw">let</span> <span class="ident">sender_certificate</span> <span class="op">=</span>
        <span class="ident">SenderCertificate::deserialize</span>(<span class="kw-2">&amp;</span><span class="ident">sender_certificate_data</span>.<span class="ident">encode_to_vec</span>())<span class="question-mark">?</span>;
    <span class="macro">assert!</span>(<span class="ident">sender_certificate</span>.<span class="ident">validate</span>(<span class="kw-2">&amp;</span><span class="ident">trust_root</span>.<span class="ident">public_key</span>()<span class="question-mark">?</span>, <span class="number">31336</span>)<span class="question-mark">?</span>);
    <span class="prelude-val">Ok</span>(())
}
</code></pre></div>
</section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="libsignal_protocol" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.61.0 (fe5b13d68 2022-05-18)" ></div>
</body></html>